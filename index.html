<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿ (Ultimate CFO)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-sub: #64748b;
      
      --c-safe: #10b981;    /* ç¶  */
      --c-warn: #f59e0b;    /* æ©˜é»ƒ */
      --c-danger: #ef4444;  /* ç´… */
      --c-blue: #3b82f6;
      --c-purple: #8b5cf6;
      --c-gold: #eab308;
      
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; transition: 0.3s; }
    .container { max-width: 1600px; margin: 0 auto; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-group button { background: var(--bg-card); border: 1px solid var(--text-sub); color: var(--text-main); padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-left:5px; font-weight:bold; transition:0.2s;}
    .btn-group button:hover { background: var(--c-blue); color: white; border-color: var(--c-blue); }

    /* Hero Section */
    .hero-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .hero-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border-top: 4px solid var(--c-blue); }
    .hero-title { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; }
    .hero-val { font-size: 1.8rem; font-weight: 800; }
    .hero-sub { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; line-height: 1.4; }

    /* Charts Section */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); height: 380px; }
    .chart-box { position: relative; height: 320px; width: 100%; }

    /* Main Layout */
    .main-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
    
    /* Asset Table */
    .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
    .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--bg-body); display: flex; justify-content: space-between; align-items: center; }

    /* Table Fixed */
    .table-container { overflow-x: auto; }
    .asset-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 800px; }
    .asset-table th { text-align: left; padding: 10px; color: var(--text-sub); border-bottom: 2px solid var(--bg-body); white-space: nowrap; }
    .asset-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    
    /* Inputs inside table */
    .inp-group { display: flex; flex-direction: column; gap: 5px; }
    .inp-label { font-size: 0.75rem; color: var(--text-sub); }
    input[type="number"] { width: 95px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-weight: 600; background: var(--bg-body); color: var(--text-main); transition:0.2s; }
    input[type="number"]:focus { border-color: var(--c-blue); background: #fff; }
    input.sm { width: 60px; font-size: 0.85rem; }

    /* Tags & Status */
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
    .b-safe { background: rgba(16,185,129,0.15); color: var(--c-safe); }
    .b-warn { background: rgba(245,158,11,0.15); color: var(--c-warn); }
    .b-danger { background: rgba(239,68,68,0.15); color: var(--c-danger); }
    
    .rule-tag { font-size: 0.75rem; color: var(--text-sub); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; border:1px solid #e2e8f0; }

    /* Risk Lines */
    .risk-lines { display: flex; flex-direction: column; gap: 6px; font-size: 0.85rem; margin-top: 8px; }
    .risk-row { display: flex; justify-content: space-between; align-items: center; background:rgba(0,0,0,0.02); padding:4px; border-radius:4px; }
    .line-val { font-weight: bold; }
    .line-trigger { font-weight: 800; margin-left:4px; }
    .line-label { color: var(--text-sub); display:flex; align-items:center; gap:4px;}
    .line-label i { font-size:0.8rem; }

    /* Slider Control */
    .sim-control { background: linear-gradient(to right, rgba(239,68,68,0.05), rgba(239,68,68,0.01)); border: 1px solid rgba(239,68,68,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
    .range-wrap { display: flex; align-items: center; gap: 15px; }
    input[type=range] { flex: 1; height: 6px; border-radius: 5px; background: #cbd5e1; outline: none; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--c-danger); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    /* Side Panel */
    .side-panel { display: flex; flex-direction: column; gap: 20px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .summary-val { font-weight: 700; }
    .total-line { border-top: 2px solid #eee; padding-top: 10px; margin-top: 5px; font-size: 1.1rem; }

    @media (max-width: 1200px) {
      .hero-grid { grid-template-columns: 1fr 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .main-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  
  <div class="header">
    <div>
      <h1 style="margin:0; color:var(--c-blue)"><i class="fas fa-university"></i> è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿</h1>
      <span style="font-size:0.85rem; color:var(--text-sub)">é¢¨éšªç›£æ§ã€è‚¡ç½æ¨¡æ“¬ã€çœŸå¯¦è² å‚µã€åˆ©æ¯åˆ†æµ</span>
    </div>
    <div class="btn-group">
      <button onclick="toggleTheme()"><i class="fas fa-adjust"></i> æ¨¡å¼</button>
      <button onclick="saveData()"><i class="fas fa-save"></i> å­˜æª”</button>
      <button onclick="calc()"><i class="fas fa-sync"></i> é‡ç®—</button>
    </div>
  </div>

  <!-- 1. æ ¸å¿ƒæ•¸æ“š -->
  <div class="hero-grid">
    <div class="hero-card">
      <div class="hero-title">çœŸå¯¦æ·¨è³‡ç”¢ (True Net Worth)</div>
      <div class="hero-val" style="color:var(--c-blue)"><span id="val_net_worth">0</span> è¬</div>
      <div class="hero-sub">ç¸½è³‡ç”¢ <span id="val_assets">0</span> ï¼ ç¸½è² å‚µ <span id="val_liabilities">0</span><br>(å«æˆ¿è²¸/ä¿¡è²¸æœ¬é‡‘)</div>
    </div>
    
    <div class="hero-card" style="border-top-color: var(--c-safe);">
      <div class="hero-title">æ¯æœˆæ·¨ç¾é‡‘æµ (Cash Flow)</div>
      <div class="hero-val" style="color:var(--c-safe)">+<span id="val_surplus">0</span> è¬</div>
      <div class="hero-sub">æœˆæ”¶ <span id="val_income">0</span> ï¼ æœˆæ”¯ <span id="val_expense">0</span><br>(å·²è‡ªå‹•æ‰£é™¤æŠ•è³‡åˆ©æ¯)</div>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-warn);">
      <div class="hero-title">ç¸½è² å‚µçµæ§‹</div>
      <div class="hero-val"><span id="val_debt_ratio">0%</span> <small style="font-size:1rem;font-weight:400">è² å‚µæ¯”</small></div>
      <div class="hero-sub">æŠ•è³‡å‚µ <span id="val_invest_debt">0</span> ï½œ ç”Ÿæ´»å‚µ <span id="val_life_debt">0</span></div>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-purple);">
      <div class="hero-title">æŠ•è³‡ç¸½æç›Š</div>
      <div class="hero-val"><span id="val_pl">0</span> è¬</div>
      <div class="hero-sub">ç¸½æŠ•å…¥æˆæœ¬ <span id="val_cost">0</span><br>ç¾å€¼ <span id="val_invest_assets">0</span></div>
    </div>
  </div>

  <!-- 2. åœ–è¡¨å€ -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;">è³‡ç”¢é…ç½® (å«æˆ¿ç”¢)</h3>
      <div class="chart-box"><canvas id="assetChart"></canvas></div>
    </div>
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;">æ”¶æ”¯çµæ§‹ (å †ç–Šåˆ†æ)</h3>
      <div class="chart-box"><canvas id="flowChart"></canvas></div>
    </div>
  </div>

  <div class="main-layout">
    
    <!-- å·¦å´ï¼šè©³ç´°è³‡ç”¢è² å‚µè¡¨ -->
    <div class="main-content">
      
      <!-- è‚¡ç½æ¨¡æ“¬æ§åˆ¶å€ -->
      <div class="sim-control">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="color:var(--c-danger)"><i class="fas fa-chart-line"></i> å¸‚å ´å£“åŠ›æ¸¬è©¦æ¨¡æ“¬ (æ»‘æ¡¿)</strong>
            <span style="background:#fff; padding:2px 8px; border-radius:4px; font-weight:bold; border:1px solid #ccc;">
                å‡è¨­è·Œå¹…ï¼š<span id="sim_label" style="color:var(--c-danger); font-size:1.1rem;">0%</span>
            </span>
        </div>
        <div class="range-wrap">
            <span style="font-size:0.8rem;">0%</span>
            <input type="range" id="sim_slider" min="0" max="60" step="1" value="0" oninput="calc()">
            <span style="font-size:0.8rem;">-60%</span>
        </div>
        <div style="font-size:0.8rem; color:var(--text-sub);">
            * æ‹–å‹•æ»‘æ¡¿ï¼Œè§€å¯Ÿä¸‹æ–¹å³å´ã€Œæ¨¡æ“¬çµæœã€æ¬„ä½ã€‚
        </div>
      </div>

      <!-- è³‡ç”¢ç›£æ§è¡¨ -->
      <div class="section-card">
        <div class="section-title">
          <span>ğŸ›¡ï¸ è³‡ç”¢æŠ—è·Œèƒ½åŠ›è©³è¡¨</span>
        </div>
        <div class="table-container">
          <table class="asset-table">
            <thead>
              <tr>
                <th style="width:20%">é …ç›® / è¦å®š</th>
                <th>ç¾å€¼ / æˆæœ¬</th>
                <th>å€Ÿæ¬¾ / åˆ©ç‡(%)</th>
                <th style="width:28%; background:rgba(59,130,246,0.02)">é¢¨éšªç¾æ³ (è§¸ç™¼åƒ¹ä½ & ç·©è¡)</th>
                <th style="width:18%; background:rgba(239,68,68,0.05)">æ¨¡æ“¬çµæœ</th>
              </tr>
            </thead>
            <tbody>
              <!-- ä¿å–® A -->
              <tr>
                <td>
                  <b>ä¿å–® A</b> (æ³•å·´å¹´é‡‘)<br>
                  <span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="asset_a" type="number" value="47" oninput="calc()" placeholder="ç¾å€¼">
                    <input id="cost_a" type="number" value="50" oninput="calc()" placeholder="æˆæœ¬" style="opacity:0.7">
                  </div>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="loan_a" type="number" value="21.5" oninput="calc()" placeholder="å€Ÿæ¬¾">
                    <div style="display:flex; align-items:center; gap:2px;">
                        <input id="rate_a" type="number" value="4.0" class="sm" oninput="calc()"> <span style="font-size:0.7rem">%</span>
                    </div>
                  </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_a"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_a"></div></td>
              </tr>
              
              <!-- ä¿å–® B -->
              <tr>
                <td>
                  <b>ä¿å–® B</b> (æ³•å·´å£½éšª)<br>
                  <span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="asset_b" type="number" value="146" oninput="calc()">
                    <input id="cost_b" type="number" value="150" oninput="calc()" style="opacity:0.7">
                  </div>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="loan_b" type="number" value="68.5" oninput="calc()">
                    <div style="display:flex; align-items:center; gap:2px;">
                        <input id="rate_b" type="number" value="4.0" class="sm" oninput="calc()"> <span style="font-size:0.7rem">%</span>
                    </div>
                  </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_b"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_b"></div></td>
              </tr>

              <!-- ä¿å–® C -->
              <tr>
                <td>
                  <b>ä¿å–® C</b> (å®‰é”å¹´é‡‘)<br>
                  <span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="asset_c" type="number" value="178" oninput="calc()">
                    <input id="cost_c" type="number" value="173" oninput="calc()" style="opacity:0.7">
                  </div>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="loan_c" type="number" value="84" oninput="calc()">
                    <div style="display:flex; align-items:center; gap:2px;">
                        <input id="rate_c" type="number" value="4.0" class="sm" oninput="calc()"> <span style="font-size:0.7rem">%</span>
                    </div>
                  </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_c"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_c"></div></td>
              </tr>

              <!-- ä¿å–® D -->
              <tr>
                <td>
                  <b>ä¿å–® D</b> (å®‰è¯ä¸»åŠ›)<br>
                  <span class="rule-tag">è£œç¹³60% / æ–·é ­70%</span>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="asset_d" type="number" value="324" oninput="calc()">
                    <input id="cost_d" type="number" value="301" oninput="calc()" style="opacity:0.7">
                  </div>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="loan_d" type="number" value="90" oninput="calc()">
                    <div style="display:flex; align-items:center; gap:2px;">
                        <input id="rate_d" type="number" value="4.0" class="sm" oninput="calc()"> <span style="font-size:0.7rem">%</span>
                    </div>
                  </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_d"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_d"></div></td>
              </tr>

              <!-- ETF -->
              <tr style="background:rgba(59,130,246,0.03)">
                <td>
                  <b>å°è‚¡ ETF</b> (è³ªæŠ¼)<br>
                  <span class="rule-tag">è¿½ç¹³ç·š ç¶­æŒç‡130%</span>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="asset_etf" type="number" value="173" oninput="calc()">
                    <input id="cost_etf" type="number" value="160" oninput="calc()" style="opacity:0.7">
                  </div>
                </td>
                <td>
                  <div class="inp-group">
                    <input id="loan_etf" type="number" value="40" oninput="calc()">
                    <div style="display:flex; align-items:center; gap:2px;">
                        <input id="rate_etf" type="number" value="2.5" class="sm" oninput="calc()"> <span style="font-size:0.7rem">%</span>
                    </div>
                  </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_etf"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_etf"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- æˆ¿ç”¢èˆ‡è² å‚µæœ¬é‡‘ -->
      <div class="section-card">
        <div class="section-title">ğŸ  æˆ¿ç”¢èˆ‡ç”Ÿæ´»è² å‚µ (æœ¬é‡‘æ­¸æˆ¶)</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            
            <div style="flex:1; min-width:200px; border-right:1px solid #eee; padding-right:20px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æˆ¿ç”¢ä¼°å€¼</h4>
                <div class="inp-group">
                    <label class="inp-label">æˆ¿å±‹å¸‚å€¼</label>
                    <input id="asset_house" type="number" value="470" oninput="calc()" style="width:100%; border-color:var(--c-blue)">
                </div>
            </div>

            <div style="flex:1; min-width:200px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æ¬ æ¬¾æœ¬é‡‘ (Outstanding Principal)</h4>
                <div style="display:flex; gap:15px;">
                    <div class="inp-group" style="flex:1">
                        <label class="inp-label">æˆ¿è²¸å‰©é¤˜æœ¬é‡‘</label>
                        <input id="debt_house" type="number" value="462" oninput="calc()" style="width:100%">
                    </div>
                    <div class="inp-group" style="flex:1">
                        <label class="inp-label">ä¿¡è²¸å‰©é¤˜æœ¬é‡‘</label>
                        <input id="debt_personal" type="number" value="98" oninput="calc()" style="width:100%">
                    </div>
                </div>
            </div>

            <div style="flex:1; min-width:150px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æµå‹•ç¾é‡‘</h4>
                <div class="inp-group">
                    <label class="inp-label">æ‰‹é ­ç¾é‡‘</label>
                    <input id="asset_cash" type="number" value="45" oninput="calc()" style="width:100%; border-color:var(--c-safe)">
                </div>
            </div>

        </div>
      </div>

    </div>

    <!-- å³å´ï¼šæ”¶æ”¯è¨ˆç®—é¢æ¿ -->
    <div class="side-panel">
      
      <!-- æ”¶å…¥ -->
      <div class="section-card">
        <h3 style="margin:0 0 15px 0; color:var(--c-blue)">ğŸ’° æœˆæ”¶å…¥</h3>
        <div class="summary-row">
            <span>ä¸»å‹•è–ªè³‡</span>
            <input id="inc_active" type="number" value="4.2" oninput="calc()">
        </div>
        <div class="summary-row">
            <span style="color:var(--c-gold); font-weight:bold;">è¢«å‹•é…æ¯</span>
            <input id="inc_passive" type="number" value="5.5" oninput="calc()">
        </div>
        <div class="summary-row total-line" style="color:var(--c-blue)">
            <span>ç¸½æ”¶å…¥</span>
            <span id="disp_inc_total">0</span>
        </div>
      </div>

      <!-- æ”¯å‡º -->
      <div class="section-card">
        <h3 style="margin:0 0 15px 0; color:var(--c-danger)">ğŸ’¸ æœˆæ”¯å‡º</h3>
        
        <div class="summary-row">
            <span>æˆ¿è²¸æœˆä¾›</span>
            <input id="exp_house" type="number" value="3.1" oninput="calc()">
        </div>
        <div class="summary-row">
            <span>ä¿¡è²¸æœˆä¾›</span>
            <input id="exp_personal" type="number" value="1.3" oninput="calc()">
        </div>
        <div class="summary-row">
            <span>ä¿éšª/ç”Ÿæ´»</span>
            <input id="exp_life" type="number" value="2.6" oninput="calc()">
        </div>
        <div class="summary-row">
            <span>å½ˆæ€§æ”¯å‡º</span>
            <input id="exp_flex" type="number" value="0.0" oninput="calc()">
        </div>
        
        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
        
        <div class="summary-row" style="color:var(--text-sub)">
            <span>ä¿å–®åˆ©æ¯(è‡ªå‹•)</span>
            <span id="disp_policy_interest">0</span>
        </div>
        <div class="summary-row" style="color:var(--text-sub)">
            <span>ETFåˆ©æ¯(è‡ªå‹•)</span>
            <span id="disp_etf_interest">0</span>
        </div>

        <div class="summary-row total-line" style="color:var(--c-danger)">
            <span>ç¸½æ”¯å‡º</span>
            <span id="disp_exp_total">0</span>
        </div>
      </div>

      <!-- çµé¤˜ -->
      <div class="section-card" style="text-align:center;">
         <div style="font-size:0.9rem; color:var(--text-sub)">æœˆç¾é‡‘æµ</div>
         <div style="font-size:2rem; font-weight:800;" id="disp_surplus_big">0</div>
         <div style="margin-top:5px; font-size:0.8rem;" id="surplus_msg"></div>
      </div>

    </div>
  </div>
</div>

<script>
  let chartAsset = null;
  let chartFlow = null;

  // Helper
  const v = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.innerHTML = txt; };

  // 1. è³‡ç”¢ç‹€æ…‹æ¸²æŸ“å‡½æ•¸
  function renderAssetStatus(id, asset, loan, mcLimit, liqLimit, isEtf) {
    // æ»‘æ¡¿å€¼
    const dropPct = parseFloat(document.getElementById('sim_slider').value);
    document.getElementById('sim_label').innerText = `-${dropPct}%`;
    
    const rate = v(`rate_${id}`);
    let interest = 0;
    if(loan > 0) interest = (loan * (rate/100)) / 12;

    // A. ç¾æ³è¨ˆç®—
    let ratioText = "";
    let color = "b-safe";
    let triggerMC = 0;
    let triggerLiq = 0;
    let bufferMC = 0;
    let bufferLiq = 0;

    if(!isEtf) {
        // ä¿å–®
        const r = asset>0 ? loan/asset*100 : 0;
        ratioText = r.toFixed(1) + "%";
        if(r >= liqLimit) color = "b-danger"; else if(r >= mcLimit) color = "b-warn";
        
        triggerMC = loan / (mcLimit/100);
        triggerLiq = loan / (liqLimit/100);
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
    } else {
        // ETF
        const r = loan>0 ? asset/loan*100 : 0;
        ratioText = loan>0 ? r.toFixed(0) + "%" : "-";
        if(loan>0 && r < 130) color = "b-warn";
        if(loan>0 && r < 115) color = "b-danger";

        triggerMC = loan * 1.3;
        triggerLiq = loan * 1.15;
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
    }

    // æ¸²æŸ“é¢¨éšªæ¬„ä½ (ä¿®å¾©é¡¯ç¤º)
    const statusHtml = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span style="font-size:0.75rem; color:var(--text-sub)">ç›®å‰</span>
            <span class="badge ${color}">${ratioText}</span>
        </div>
        <div class="risk-lines">
            <div class="risk-row">
                <span class="line-label" title="è£œç¹³ç·š"><i class="fas fa-exclamation-triangle" style="color:var(--c-warn)"></i> è·Œè‡³ <span class="line-trigger" style="color:var(--c-warn)">${triggerMC.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-warn); font-size:0.85rem;">å‰© ${bufferMC.toFixed(0)}%</span>
            </div>
            <div class="risk-row">
                <span class="line-label" title="æ–·é ­ç·š"><i class="fas fa-skull" style="color:var(--c-danger)"></i> è·Œè‡³ <span class="line-trigger" style="color:var(--c-danger)">${triggerLiq.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-danger); font-size:0.85rem;">å‰© ${bufferLiq.toFixed(0)}%</span>
            </div>
        </div>
    `;
    t(`status_${id}`, statusHtml);

    // B. æ¨¡æ“¬
    const factor = 1 - (dropPct / 100);
    const simAsset = asset * factor;
    let simTxt = "å®‰å…¨";
    let simCls = "b-safe";
    let simRatioVal = 0;

    if(!isEtf) {
        simRatioVal = simAsset>0 ? loan/simAsset*100 : 0;
        if(simRatioVal >= liqLimit) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
        else if(simRatioVal >= mcLimit) { simTxt = "è£œç¹³"; simCls = "b-warn"; }
    } else {
        simRatioVal = loan>0 ? simAsset/loan*100 : 0; 
        if(loan>0) {
            if(simRatioVal < 115) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
            else if(simRatioVal < 130) { simTxt = "è¿½ç¹³"; simCls = "b-warn"; }
        }
    }

    const simDisplayRatio = isEtf ? (loan>0?simRatioVal.toFixed(0)+"%":"-") : simRatioVal.toFixed(1)+"%";
    const simHtml = `
        <div style="font-weight:bold; font-size:0.9rem;">${simAsset.toFixed(0)} <small style="color:var(--text-sub)">è¬</small></div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.8rem;">
            <span>${simDisplayRatio}</span>
            <span class="badge ${simCls}">${simTxt}</span>
        </div>
    `;
    t(`sim_res_${id}`, simHtml);

    return { interest };
  }

  function calc() {
    let policyTotalInterest = 0;
    let etfTotalInterest = 0;
    
    const rA = renderAssetStatus('a', v('asset_a'), v('loan_a'), 80, 90, false);
    const rB = renderAssetStatus('b', v('asset_b'), v('loan_b'), 80, 90, false);
    const rC = renderAssetStatus('c', v('asset_c'), v('loan_c'), 80, 90, false);
    const rD = renderAssetStatus('d', v('asset_d'), v('loan_d'), 60, 70, false);
    policyTotalInterest = rA.interest + rB.interest + rC.interest + rD.interest;

    const rE = renderAssetStatus('etf', v('asset_etf'), v('loan_etf'), 0, 0, true);
    etfTotalInterest = rE.interest;

    t('disp_policy_interest', policyTotalInterest.toFixed(2));
    t('disp_etf_interest', etfTotalInterest.toFixed(2));
    const totalInvestInterest = policyTotalInterest + etfTotalInterest;

    const investAsset = v('asset_a')+v('asset_b')+v('asset_c')+v('asset_d')+v('asset_etf');
    const investDebt = v('loan_a')+v('loan_b')+v('loan_c')+v('loan_d')+v('loan_etf');
    const investCost = v('cost_a')+v('cost_b')+v('cost_c')+v('cost_d')+v('cost_etf');
    const houseVal = v('asset_house');
    const houseDebt = v('debt_house');
    const personalDebt = v('debt_personal');
    const cash = v('asset_cash');

    const totalAssets = investAsset + houseVal + cash;
    const totalLiabilities = investDebt + houseDebt + personalDebt;
    const netWorth = totalAssets - totalLiabilities;

    t('val_net_worth', netWorth.toLocaleString());
    t('val_assets', totalAssets.toLocaleString());
    t('val_liabilities', totalLiabilities.toLocaleString());
    t('val_invest_assets', investAsset.toLocaleString());
    t('val_cost', investCost.toLocaleString());
    
    const pl = investAsset - investCost;
    const elPl = document.getElementById('val_pl');
    elPl.innerText = (pl>0?"+":"") + pl.toLocaleString();
    elPl.style.color = pl>=0 ? "var(--c-safe)" : "var(--c-danger)";

    t('val_invest_debt', investDebt.toLocaleString());
    t('val_life_debt', (houseDebt+personalDebt).toLocaleString());
    
    const debtRatio = totalAssets>0 ? (totalLiabilities/totalAssets*100) : 0;
    t('val_debt_ratio', debtRatio.toFixed(1)+"%");

    const incAct = v('inc_active');
    const incPas = v('inc_passive');
    const inc = incAct + incPas;
    t('disp_inc_total', inc.toFixed(2));
    t('val_income', inc.toFixed(1));

    const expFix = v('exp_house') + v('exp_personal') + v('exp_life') + v('exp_flex');
    const totalExp = expFix + totalInvestInterest;
    t('disp_exp_total', totalExp.toFixed(2));
    t('val_expense', totalExp.toFixed(1));

    const surplus = inc - totalExp;
    t('val_surplus', surplus.toFixed(2));
    
    const surBig = document.getElementById('disp_surplus_big');
    surBig.innerText = (surplus>0?"+":"") + surplus.toFixed(2) + " è¬";
    surBig.style.color = surplus>=0 ? "var(--c-safe)" : "var(--c-danger)";
    t('surplus_msg', surplus>=0 ? "è²¡å‹™å¥åº·" : "ç¾é‡‘æµèµ¤å­—");

    updateCharts([investAsset, houseVal, cash], [incAct, incPas, totalExp]);
  }

  function initCharts() {
    chartAsset = new Chart(document.getElementById('assetChart'), {
        type: 'doughnut',
        data: {
            labels: ['æŠ•è³‡', 'æˆ¿ç”¢', 'ç¾é‡‘'],
            datasets: [{ data: [1, 1, 1], backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981'], borderWidth: 0 }]
        },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%' }
    });

    chartFlow = new Chart(document.getElementById('flowChart'), {
        type: 'bar',
        data: {
            labels: ['æ”¶æ”¯'],
            datasets: [
                { label: 'ä¸»å‹•', data: [0], backgroundColor: '#3b82f6', stack: 'Income' },
                { label: 'è¢«å‹•', data: [0], backgroundColor: '#eab308', stack: 'Income' },
                { label: 'æ”¯å‡º', data: [0], backgroundColor: '#ef4444', stack: 'Expense' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
    });
  }

  function updateCharts(assets, flows) {
    if(chartAsset) { chartAsset.data.datasets[0].data = assets; chartAsset.update(); }
    if(chartFlow) { chartFlow.data.datasets[0].data = [flows[0]]; chartFlow.data.datasets[1].data = [flows[1]]; chartFlow.data.datasets[2].data = [flows[2]]; chartFlow.update(); }
  }

  function saveData() {
    const d = {};
    document.querySelectorAll('input').forEach(e => d[e.id] = e.value);
    localStorage.setItem('wcj_cfo_final_fixed', JSON.stringify(d));
    alert('å·²å„²å­˜');
  }
  function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'); }

  window.onload = () => {
    initCharts();
    const d = JSON.parse(localStorage.getItem('wcj_cfo_final_fixed'));
    if(d) for(k in d) if(document.getElementById(k)) document.getElementById(k).value=d[k];
    calc();
  };
</script>
</body>
</html>
