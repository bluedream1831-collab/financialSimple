<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿ (Final Complete)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-sub: #64748b;
      
      --c-safe: #10b981;    /* ç¶  */
      --c-warn: #f59e0b;    /* æ©˜ */
      --c-danger: #ef4444;  /* ç´… */
      --c-blue: #3b82f6;
      --c-purple: #8b5cf6;
      --c-gold: #eab308;
      --c-orange: #f97316;
      
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; transition: 0.3s; }
    
    #dashboard-container { max-width: 1600px; margin: 0 auto; background: var(--bg-body); padding: 10px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
    .btn-group button { background: var(--bg-card); border: 1px solid var(--text-sub); color: var(--text-main); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight:bold; transition:0.2s; font-size: 0.85rem; }
    .btn-group button:hover { background: var(--c-blue); color: white; border-color: var(--c-blue); }
    .btn-pdf { border-color: var(--c-danger) !important; color: var(--c-danger) !important; }
    .btn-pdf:hover { background: var(--c-danger) !important; color: white !important; }
    .btn-privacy { border-color: var(--text-main) !important; }
    .btn-privacy.active { background: var(--text-main); color: var(--bg-card); }

    /* Hero Section */
    .hero-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .hero-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border-top: 4px solid var(--c-blue); }
    .hero-title { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; }
    .hero-val { font-size: 1.8rem; font-weight: 800; }
    .hero-sub { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; line-height: 1.4; }

    /* Charts Section */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); height: 380px; page-break-inside: avoid; }
    .chart-box { position: relative; height: 320px; width: 100%; }

    /* Main Layout */
    .main-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
    
    /* Section Card */
    .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
    .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--bg-body); display: flex; justify-content: space-between; align-items: center; }

    /* Asset Table */
    .table-container { overflow-x: auto; }
    .asset-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 950px; }
    .asset-table th { text-align: left; padding: 10px; color: var(--text-sub); border-bottom: 2px solid var(--bg-body); white-space: nowrap; }
    .asset-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    
    /* Inputs */
    .inp-group { display: flex; flex-direction: column; gap: 5px; }
    input[type="number"] { width: 95px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-weight: 600; background: var(--bg-body); color: var(--text-main); transition:0.2s; }
    input[type="number"]:focus { border-color: var(--c-blue); background: #fff; }
    input.sm { width: 60px; font-size: 0.85rem; }
    
    /* Date Input */
    .date-wrapper { display:flex; flex-direction:column; gap:2px; margin-top:5px; }
    input[type="date"] { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.75rem; color: var(--text-sub); width: 100%; margin-top: 4px; background: transparent; }
    .duration-tag { font-size:0.75rem; color: var(--c-blue); font-weight:bold; }

    /* Badges & ROI */
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
    .b-safe { background: rgba(16,185,129,0.15); color: var(--c-safe); }
    .b-warn { background: rgba(245,158,11,0.15); color: var(--c-warn); }
    .b-danger { background: rgba(239,68,68,0.15); color: var(--c-danger); }
    
    .roi-wrapper { margin-top:6px; font-size:0.75rem; display:flex; flex-direction:column; gap:3px; border-top:1px dashed #eee; padding-top:4px; }
    .roi-row { display:flex; justify-content:space-between; }
    .roi-val { font-weight:bold; font-family: monospace;}
    .c-up { color: var(--c-safe); }
    .c-down { color: var(--c-danger); }

    .rule-tag { font-size: 0.75rem; color: var(--text-sub); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; border:1px solid #e2e8f0; font-weight:600; }

    /* Water Level & Risk */
    .water-track { position: relative; width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 8px; overflow: hidden; }
    .water-fill { height: 100%; background: var(--c-safe); border-radius: 5px; transition: width 0.5s ease, background 0.3s; }
    .water-mark { position: absolute; top: 0; bottom: 0; width: 2px; z-index: 2; }
    .mark-mc { background: var(--c-warn); }
    .mark-liq { background: var(--c-danger); }

    .risk-lines { display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; margin-top: 6px; }
    .risk-row { display: flex; justify-content: space-between; align-items: center; background:rgba(0,0,0,0.02); padding:3px 5px; border-radius:4px; }
    .line-val { font-weight: bold; }
    .line-trigger { font-weight: 800; margin-left:4px; }
    .line-label { color: var(--text-sub); display:flex; align-items:center; gap:4px; font-size:0.8rem;}

    /* Slider */
    .sim-control { background: linear-gradient(to right, rgba(239,68,68,0.05), rgba(239,68,68,0.01)); border: 1px solid rgba(239,68,68,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
    .range-wrap { display: flex; align-items: center; gap: 15px; }
    input[type=range] { flex: 1; height: 6px; border-radius: 5px; background: #cbd5e1; outline: none; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--c-danger); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    /* Side Panel */
    .side-panel { display: flex; flex-direction: column; gap: 20px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .summary-val { font-weight: 700; }
    .total-line { border-top: 2px solid #eee; padding-top: 10px; margin-top: 5px; font-size: 1.1rem; }

    /* AI Advice */
    .ai-box { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border: 1px solid #bfdbfe; padding: 20px; border-radius: 12px; margin-top: 20px; position: relative; overflow: hidden; page-break-inside: avoid; }
    [data-theme="dark"] .ai-box { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-color: #334155; }
    .ai-title { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--c-blue); font-size: 1.1rem; margin-bottom: 10px; }
    .ai-content { font-size: 0.95rem; line-height: 1.6; color: var(--text-main); margin-bottom: 15px; }
    .ai-icon-bg { position: absolute; right: -10px; bottom: -20px; font-size: 6rem; opacity: 0.05; color: var(--c-blue); transform: rotate(-15deg); }

    details { background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 8px; overflow: hidden; transition: 0.3s; page-break-inside: avoid; }
    details summary { padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--text-sub); display: flex; align-items: center; gap: 8px; outline: none; }
    details summary:hover { background: rgba(0,0,0,0.02); color: var(--c-blue); }
    details[open] { background: rgba(255,255,255,0.8); box-shadow: 0 4px 6px -2px rgba(0,0,0,0.05); }
    details p { padding: 0 15px 15px 15px; margin: 0; font-size: 0.9rem; color: var(--text-main); line-height: 1.6; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 5px; padding-top: 10px; }
    .highlight-val { color: var(--c-blue); font-weight: bold; }

    /* Privacy Mode */
    body.privacy-mode input[type="number"],
    body.privacy-mode .privacy-blur {
        color: transparent !important;
        text-shadow: 0 0 8px rgba(0,0,0,0.5);
        cursor: default;
    }
    body.privacy-mode input[type="number"]:focus {
        color: var(--text-main) !important;
        text-shadow: none;
    }

    @media (max-width: 1200px) {
      .hero-grid { grid-template-columns: 1fr 1fr; }
      .charts-grid { grid-template-columns: 1fr; }
      .main-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container" id="dashboard-container">
  
  <div class="header">
    <div>
      <h1 style="margin:0; color:var(--c-blue)"><i class="fas fa-university"></i> è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿</h1>
      <span style="font-size:0.85rem; color:var(--text-sub)">æŒæœ‰ç´€éŒ„ã€å«æ¯å ±é…¬ã€è£œç¹³è©¦ç®—ã€çœŸå¯¦è² å‚µ</span>
    </div>
    <div class="btn-group" data-html2canvas-ignore="true">
      <button onclick="togglePrivacy()" id="btnPrivacy" class="btn-privacy"><i class="fas fa-eye"></i> éš±è—é‡‘é¡</button>
      <button onclick="toggleTheme()"><i class="fas fa-adjust"></i> æ¨¡å¼</button>
      <button onclick="saveData()"><i class="fas fa-save"></i> å­˜æª”</button>
      <button onclick="calc()"><i class="fas fa-sync"></i> é‡ç®—</button>
      <button onclick="exportPDF()" class="btn-pdf"><i class="fas fa-file-pdf"></i> åŒ¯å‡º PDF</button>
    </div>
  </div>

  <!-- 1. æ ¸å¿ƒæ•¸æ“š -->
  <div class="hero-grid">
    <div class="hero-card">
      <div class="hero-title">çœŸå¯¦æ·¨è³‡ç”¢ (True Net Worth)</div>
      <div class="hero-val privacy-blur" style="color:var(--c-blue)"><span id="val_net_worth">0</span> è¬</div>
      <div class="hero-sub">ç¸½è³‡ç”¢ <span id="val_assets" class="privacy-blur">0</span> ï¼ ç¸½è² å‚µ <span id="val_liabilities" class="privacy-blur">0</span><br>(å«æˆ¿è²¸/ä¿¡è²¸æœ¬é‡‘)</div>
    </div>
    
    <div class="hero-card" style="border-top-color: var(--c-safe);">
      <div class="hero-title">æ¯æœˆæ·¨ç¾é‡‘æµ (Cash Flow)</div>
      <div class="hero-val privacy-blur" style="color:var(--c-safe)">+<span id="val_surplus">0</span> è¬</div>
      <div class="hero-sub">æœˆæ”¶ <span id="val_income" class="privacy-blur">0</span> ï¼ æœˆæ”¯ <span id="val_expense" class="privacy-blur">0</span><br>(å·²è‡ªå‹•æ‰£é™¤æŠ•è³‡åˆ©æ¯)</div>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-warn);">
      <div class="hero-title">ç¸½è² å‚µçµæ§‹</div>
      <div class="hero-val"><span id="val_debt_ratio">0%</span> <small style="font-size:1rem;font-weight:400">è² å‚µæ¯”</small></div>
      <div class="hero-sub">æŠ•è³‡å‚µ <span id="val_invest_debt" class="privacy-blur">0</span> ï½œ ç”Ÿæ´»å‚µ <span id="val_life_debt" class="privacy-blur">0</span></div>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-purple);">
      <div class="hero-title">æŠ•è³‡ç¸½æç›Š (å«æ¯)</div>
      <div class="hero-val privacy-blur"><span id="val_pl">0</span> è¬</div>
      <div class="hero-sub">ç¸½æŠ•å…¥ <span id="val_cost" class="privacy-blur">0</span> ï½œ ç¾å€¼ <span id="val_invest_assets" class="privacy-blur">0</span><br>ç´¯ç©é…æ¯ <span id="val_total_div" class="privacy-blur">0</span></div>
    </div>
  </div>

  <!-- 2. åœ–è¡¨å€ -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;">è³‡ç”¢é…ç½® (å«æˆ¿ç”¢)</h3>
      <div class="chart-box"><canvas id="assetChart"></canvas></div>
    </div>
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;">æ”¶æ”¯çµæ§‹ (å †ç–Šåˆ†æ)</h3>
      <div class="chart-box"><canvas id="flowChart"></canvas></div>
    </div>
  </div>

  <div class="main-layout">
    
    <!-- å·¦å´ï¼šè©³ç´°è³‡ç”¢è² å‚µè¡¨ -->
    <div class="main-content">
      
      <!-- è‚¡ç½æ¨¡æ“¬æ§åˆ¶å€ -->
      <div class="sim-control">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <strong style="color:var(--c-danger)"><i class="fas fa-chart-line"></i> å¸‚å ´å£“åŠ›æ¸¬è©¦æ¨¡æ“¬ (æ»‘æ¡¿)</strong>
            <span style="background:#fff; padding:2px 8px; border-radius:4px; font-weight:bold; border:1px solid #ccc;">
                å‡è¨­è·Œå¹…ï¼š<span id="sim_label" style="color:var(--c-danger); font-size:1.1rem;">0%</span>
            </span>
        </div>
        <div class="range-wrap">
            <span style="font-size:0.8rem;">0%</span>
            <input type="range" id="sim_slider" min="0" max="60" step="1" value="0" oninput="calc()">
            <span style="font-size:0.8rem;">-60%</span>
        </div>
        <div style="font-size:0.8rem; color:var(--text-sub);">
            * æ‹–å‹•æ»‘æ¡¿ï¼Œå³å´è¡¨æ ¼å°‡è‡ªå‹•è¨ˆç®—ã€Œéœ€è£œç¹³é‡‘é¡ã€ã€‚
        </div>
      </div>

      <!-- è³‡ç”¢ç›£æ§è¡¨ -->
      <div class="section-card">
        <div class="section-title">
          <span>ğŸ›¡ï¸ è³‡ç”¢æŒæœ‰èˆ‡é¢¨éšªè©³è¡¨</span>
        </div>
        <div class="table-container">
          <table class="asset-table">
            <thead>
              <tr>
                <th style="width:20%">é …ç›® / æŒæœ‰æ™‚é–“</th>
                <th>ç¾å€¼ / æˆæœ¬ / ç´¯ç©é…æ¯</th>
                <th>å€Ÿæ¬¾ / åˆ©ç‡(%)</th>
                <th style="width:30%; background:rgba(59,130,246,0.02)">é¢¨éšªç¾æ³ (è§¸ç™¼åƒ¹ & æ°´ä½)</th>
                <th style="width:15%; background:rgba(239,68,68,0.05)">æ¨¡æ“¬çµæœ (è£œç¹³è©¦ç®—)</th>
              </tr>
            </thead>
            <tbody>
              <!-- ä¿å–® A -->
              <tr>
                <td>
                    <b>ä¿å–® A</b> (æ³•å·´å¹´é‡‘)<br>
                    <span class="rule-tag">è£œç¹³ 80% / æ–·é ­ 90%</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_a" value="2024-09-01" onchange="calc()">
                        <div id="dur_a" class="duration-tag">è¨ˆç®—ä¸­...</div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_a" type="number" value="47.7" oninput="calc()" placeholder="ç¾å€¼">
                        <input id="cost_a" type="number" value="50" oninput="calc()" placeholder="æˆæœ¬" style="opacity:0.7">
                        <input id="div_a" type="number" value="4.4" oninput="calc()" placeholder="ç´¯ç©é…æ¯" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_a" style="margin-top:2px;"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_a" type="number" value="21.5" oninput="calc()" placeholder="å€Ÿæ¬¾">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_a" type="number" value="3.17" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_a"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_a"></div></td>
              </tr>
              
              <!-- ä¿å–® B -->
              <tr>
                <td>
                    <b>ä¿å–® B</b> (æ³•å·´å£½éšª)<br>
                    <span class="rule-tag">è£œç¹³ 80% / æ–·é ­ 90%</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_b" value="2024-10-01" onchange="calc()">
                        <div id="dur_b" class="duration-tag">è¨ˆç®—ä¸­...</div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_b" type="number" value="147.8" oninput="calc()">
                        <input id="cost_b" type="number" value="150" oninput="calc()" style="opacity:0.7">
                        <input id="div_b" type="number" value="13.2" oninput="calc()" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_b"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_b" type="number" value="68.5" oninput="calc()">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_b" type="number" value="3.17" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_b"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_b"></div></td>
              </tr>

              <!-- ä¿å–® C -->
              <tr>
                <td>
                    <b>ä¿å–® C</b> (å®‰é”å¹´é‡‘)<br>
                    <span class="rule-tag">è£œç¹³ 80% / æ–·é ­ 90%</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_c" value="2025-09-01" onchange="calc()">
                        <div id="dur_c" class="duration-tag">è¨ˆç®—ä¸­...</div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_c" type="number" value="180" oninput="calc()">
                        <input id="cost_c" type="number" value="173" oninput="calc()" style="opacity:0.7">
                        <input id="div_c" type="number" value="3.3" oninput="calc()" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_c" style="margin-top:2px;"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_c" type="number" value="84" oninput="calc()">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_c" type="number" value="4.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_c"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_c"></div></td>
              </tr>

              <!-- ä¿å–® D -->
              <tr>
                <td>
                    <b>ä¿å–® D</b> (å®‰è¯ä¸»åŠ›)<br>
                    <span class="rule-tag">è£œç¹³ 60% / æ–·é ­ 70%</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_d" value="2025-07-01" onchange="calc()">
                        <div id="dur_d" class="duration-tag">è¨ˆç®—ä¸­...</div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_d" type="number" value="328" oninput="calc()">
                        <input id="cost_d" type="number" value="303" oninput="calc()" style="opacity:0.7">
                        <input id="div_d" type="number" value="9.8" oninput="calc()" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_d" style="margin-top:2px;"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_d" type="number" value="88" oninput="calc()">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_d" type="number" value="4.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_d"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_d"></div></td>
              </tr>

              <!-- ä¿å–® E -->
              <tr>
                <td>
                    <b>ä¿å–® E</b> (é é›„äººå£½)<br>
                    <span class="rule-tag" style="background:#ecfccb; color:#365314; border-color:#bef264;">å„²è“„å‹ / ç„¡è‚¡å¸‚é¢¨éšª</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_e" onchange="calc()">
                        <div id="dur_e" class="duration-tag"></div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_e" type="number" value="15" oninput="calc()">
                        <input id="cost_e" type="number" value="15" oninput="calc()" style="opacity:0.7">
                        <input id="div_e" type="number" value="0" oninput="calc()" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_e" style="margin-top:2px;"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_e" type="number" value="8" oninput="calc()">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_e" type="number" value="3.1" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_e"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_e"></div></td>
              </tr>

              <!-- ETF -->
              <tr style="background:rgba(59,130,246,0.03)">
                <td>
                    <b>å°è‚¡ ETF</b> (è³ªæŠ¼)<br>
                    <span class="rule-tag">è¿½ç¹³ç·š 130% / æ–·é ­ 115%</span>
                    <div class="date-wrapper">
                        <input type="date" id="date_etf" onchange="calc()">
                        <div id="dur_etf" class="duration-tag">è¨ˆç®—ä¸­...</div>
                    </div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="asset_etf" type="number" value="171" oninput="calc()">
                        <input id="cost_etf" type="number" value="175" oninput="calc()" style="opacity:0.7">
                        <input id="div_etf" type="number" value="12.6" oninput="calc()" style="border-color:var(--c-gold); color:var(--c-gold);">
                    </div>
                    <div id="roi_etf" style="margin-top:2px;"></div>
                </td>
                <td>
                    <div class="inp-group">
                        <input id="loan_etf" type="number" value="34.5" oninput="calc()">
                        <div style="display:flex;align-items:center;gap:2px;">
                            <input id="rate_etf" type="number" value="3.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span>
                        </div>
                    </div>
                </td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_etf"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_etf"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- æˆ¿ç”¢èˆ‡è² å‚µ -->
      <div class="section-card">
        <div class="section-title">ğŸ  æˆ¿ç”¢èˆ‡ç”Ÿæ´»è² å‚µ (æœ¬é‡‘æ­¸æˆ¶)</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æˆ¿ç”¢ä¼°å€¼</h4>
                <input id="asset_house" type="number" value="470" oninput="calc()" style="width:100%; border-color:var(--c-blue)">
            </div>
            <div style="flex:1; min-width:200px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æ¬ æ¬¾æœ¬é‡‘</h4>
                <div style="display:flex; gap:15px;">
                    <div><label style="font-size:0.8rem">æˆ¿è²¸é¤˜é¡</label><input id="debt_house" type="number" value="462" oninput="calc()" style="width:100%"></div>
                    <div><label style="font-size:0.8rem">ä¿¡è²¸é¤˜é¡</label><input id="debt_personal" type="number" value="98" oninput="calc()" style="width:100%"></div>
                </div>
            </div>
            <div style="flex:1; min-width:150px;">
                <h4 style="margin:0 0 10px 0; color:var(--text-sub)">æµå‹•ç¾é‡‘</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <div class="inp-group" style="flex:1">
                        <label class="inp-label">æ‰‹é ­ç¾é‡‘</label>
                        <input id="asset_cash" type="number" value="40" oninput="calc()" style="border-color:var(--c-safe); width:100%">
                    </div>
                    <div class="inp-group" style="flex:1">
                        <label class="inp-label">æœªç”¨å¾ªç’°ä¿¡è²¸</label>
                        <input id="unused_credit" type="number" value="36" oninput="calc()" style="width:100%">
                    </div>
                    <div class="inp-group" style="flex:1">
                        <label class="inp-label">æœªç”¨è³ªæŠ¼é¡åº¦</label>
                        <input id="unused_pledge" type="number" value="50" oninput="calc()" style="width:100%">
                    </div>
                </div>
                <div id="total_liquidity_display" style="font-size:0.85rem; color:var(--c-safe); margin-top:6px; font-weight:bold; text-align:right;"></div>
            </div>
        </div>
      </div>

      <!-- AI å»ºè­° -->
      <div class="ai-box">
        <div class="ai-title"><i class="fas fa-robot"></i> AI è²¡å‹™ç¸½çµèˆ‡å»ºè­°</div>
        <div id="ai_advice_content" class="ai-content">æ­£åœ¨åˆ†ææ‚¨çš„è²¡å‹™æ•¸æ“š...</div>
        <div class="ai-title" style="margin-top:20px; font-size:1rem;"><i class="fas fa-lightbulb"></i> é»æ“ŠæŸ¥çœ‹ï¼šè¨ˆç®—é‚è¼¯èˆ‡è©³ç´°è§£èªª</div>
        <div id="ai_explained_container"></div>
        <i class="fas fa-brain ai-icon-bg"></i>
      </div>

    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="side-panel">
      
      <!-- æ”¶å…¥ -->
      <div class="section-card">
        <h3 style="margin:0 0 15px 0; color:var(--c-blue)">ğŸ’° æœˆæ”¶å…¥</h3>
        <div class="summary-row"><span>ä¸»å‹•è–ªè³‡</span><input id="inc_active" type="number" value="4.2" oninput="calc()"></div>
        <div class="summary-row"><span style="color:var(--c-gold); font-weight:bold;">è¢«å‹•é…æ¯</span><input id="inc_passive" type="number" value="5.5" oninput="calc()"></div>
        <div class="summary-row total-line" style="color:var(--c-blue)"><span>ç¸½æ”¶å…¥</span><span id="disp_inc_total" class="privacy-blur">0</span></div>
      </div>

      <!-- æ”¯å‡º -->
      <div class="section-card">
        <h3 style="margin:0 0 15px 0; color:var(--c-danger)">ğŸ’¸ æœˆæ”¯å‡º</h3>
        <div class="summary-row"><span>æˆ¿è²¸æœˆä¾›</span><input id="exp_house" type="number" value="3.1" oninput="calc()"></div>
        <div class="summary-row"><span>ä¿¡è²¸æœˆä¾›</span><input id="exp_personal" type="number" value="1.3" oninput="calc()"></div>
        <div class="summary-row"><span>ä¿éšª/ç”Ÿæ´»</span><input id="exp_life" type="number" value="2.0" oninput="calc()"></div>
        <div class="summary-row"><span>å½ˆæ€§æ”¯å‡º</span><input id="exp_flex" type="number" value="0.0" oninput="calc()"></div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
        <div class="summary-row" style="color:var(--text-sub)"><span>ä¿å–®åˆ©æ¯(è‡ªå‹•)</span><span id="disp_policy_interest" class="privacy-blur">0</span></div>
        <div class="summary-row" style="color:var(--text-sub)"><span>ETFåˆ©æ¯(è‡ªå‹•)</span><span id="disp_etf_interest" class="privacy-blur">0</span></div>
        <div class="summary-row total-line" style="color:var(--c-danger)"><span>ç¸½æ”¯å‡º</span><span id="disp_exp_total" class="privacy-blur">0</span></div>
      </div>

      <!-- çµé¤˜ -->
      <div class="section-card" style="text-align:center;">
         <div style="font-size:0.9rem; color:var(--text-sub)">æœˆç¾é‡‘æµ</div>
         <div style="font-size:2rem; font-weight:800;" id="disp_surplus_big" class="privacy-blur">0</div>
         <div style="margin-top:5px; font-size:0.8rem;" id="surplus_msg"></div>
      </div>

    </div>
  </div>
</div>

<script>
  let chartAsset = null;
  let chartFlow = null;

  const v = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.innerHTML = txt; };

  function calcDuration(dateStr, elId) {
    if(!dateStr) { t(elId, "æœªè¨­å®š"); return; }
    const start = new Date(dateStr);
    const now = new Date();
    if (start > now) { t(elId, "å¾…ç”Ÿæ•ˆ (æœªä¾†)"); return; }
    let months = (now.getFullYear() - start.getFullYear()) * 12;
    months -= start.getMonth();
    months += now.getMonth();
    const years = Math.floor(months / 12);
    const remMonths = months % 12;
    let txt = "";
    if (years > 0) txt += `${years}å¹´`;
    txt += `${remMonths}å€‹æœˆ`;
    if (years===0 && remMonths===0) txt = "æœªæ»¿1å€‹æœˆ";
    t(elId, `æŒæœ‰: ${txt}`);
  }

  function renderAssetStatus(id, asset, loan, cost, mcLimit, liqLimit, isEtf, isSavings=false) {
    const divAcc = v(`div_${id}`);
    const roi = cost > 0 ? ((asset + divAcc - cost) / cost * 100) : 0;
    const priceRoi = cost > 0 ? ((asset - cost) / cost * 100) : 0;
    
    const getColor = (val) => val >= 0 ? 'c-up' : 'c-down';
    const getSym = (val) => val >= 0 ? '+' : '';

    const roiHtml = `
        <div class="roi-wrapper">
            <div class="roi-row">
                <span style="font-size:0.7rem; color:var(--text-sub)">å«æ¯</span>
                <span class="roi-val ${getColor(roi)}">${getSym(roi)} ${roi.toFixed(1)}%</span>
            </div>
            <div class="roi-row">
                <span style="font-size:0.7rem; color:var(--text-sub)">ä¸å«æ¯</span>
                <span class="roi-val ${getColor(priceRoi)}">${getSym(priceRoi)} ${priceRoi.toFixed(1)}%</span>
            </div>
        </div>
    `;
    t(`roi_${id}`, roiHtml);

    const dateVal = document.getElementById(`date_${id}`).value;
    calcDuration(dateVal, `dur_${id}`);

    const dropPct = parseFloat(document.getElementById('sim_slider').value);
    document.getElementById('sim_label').innerText = `-${dropPct}%`;
    
    const rate = v(`rate_${id}`);
    let interest = 0;
    if(loan > 0) interest = (loan * (rate/100)) / 12;

    let ratioText = "";
    let color = "b-safe";
    let triggerMC = 0, triggerLiq = 0;
    let bufferMC = 0, bufferLiq = 0;
    let barWidth = 0;

    if (isSavings) {
        ratioText = asset > 0 ? (loan/asset*100).toFixed(1) + "%" : "0%";
        const statusHtml = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                <span style="font-size:0.75rem; color:var(--text-sub)">å€Ÿæ¬¾æ¯” <span class="badge b-safe" style="font-size:0.7rem; padding:2px 6px;">${ratioText}</span></span>
            </div>
            <div style="font-size:0.85rem; color:var(--c-safe); font-weight:bold; margin-top:8px;">ğŸŸ¢ å„²è“„å‹ (ç„¡è‚¡å¸‚é¢¨éšª)</div>
        `;
        t(`status_${id}`, statusHtml);
        const simHtml = `
            <div style="font-weight:bold; font-size:0.9rem;" class="privacy-blur">${asset.toFixed(0)} <small style="color:var(--text-sub)">è¬</small></div>
            <div style="font-size:0.8rem; color:var(--text-sub); margin-top:4px;">ğŸ›¡ï¸ åƒ¹å€¼æ†å®š</div>
        `;
        t(`sim_res_${id}`, simHtml);
        return { interest, bufferMC: 100, bufferLiq: 100, name: id, divAcc, loan, asset };
    }

    if(!isEtf) {
        const r = asset>0 ? loan/asset*100 : 0;
        ratioText = r.toFixed(1) + "%";
        if(r >= liqLimit) color = "b-danger"; else if(r >= mcLimit) color = "b-warn";
        
        triggerMC = loan / (mcLimit/100);
        triggerLiq = loan / (liqLimit/100);
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
        barWidth = Math.min(r, 100);
    } else {
        // ETF Dual Ratio: LTV & Maint
        const maint = loan>0 ? asset/loan*100 : 0;
        const ltv = asset>0 ? loan/asset*100 : 0;
        
        ratioText = `å€Ÿ${ltv.toFixed(1)}% | ç¶­${maint.toFixed(0)}%`;

        if(loan>0 && maint < 130) color = "b-warn";
        if(loan>0 && maint < 115) color = "b-danger";

        triggerMC = loan * 1.3;
        triggerLiq = loan * 1.15;
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
        barWidth = Math.min(ltv, 100);
    }

    let barColor = "var(--c-safe)";
    let posMC = isEtf ? 77 : mcLimit;
    let posLiq = isEtf ? 87 : liqLimit;

    if(barWidth >= posMC) barColor = "var(--c-warn)";
    if(barWidth >= posLiq) barColor = "var(--c-danger)";

    const statusHtml = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
            <span style="font-size:0.75rem; color:var(--text-sub)">${isEtf ? 'é¢¨éšªæŒ‡æ¨™' : 'å€Ÿæ¬¾æ¯”'} <span class="badge ${color}" style="font-size:0.7rem; padding:2px 6px;">${ratioText}</span></span>
        </div>
        <div class="water-track" title="æ°´ä½åœ–">
            <div class="water-fill" style="width:${barWidth}%; background:${barColor}"></div>
            <div class="water-mark mark-mc" style="left:${posMC}%" title="è£œç¹³ç·š"></div>
            <div class="water-mark mark-liq" style="left:${posLiq}%" title="æ–·é ­ç·š"></div>
        </div>
        <div class="risk-lines">
            <div class="risk-row">
                <span class="line-label"><i class="fas fa-exclamation-circle" style="color:var(--c-warn)"></i> è£œç¹³ç·š <span class="line-trigger privacy-blur" style="color:var(--c-warn)">${triggerMC.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-warn); font-size:0.85rem;">å‰© ${bufferMC.toFixed(0)}%</span>
            </div>
            <div class="risk-row">
                <span class="line-label"><i class="fas fa-skull" style="color:var(--c-danger)"></i> æ–·é ­ç·š <span class="line-trigger privacy-blur" style="color:var(--c-danger)">${triggerLiq.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-danger); font-size:0.85rem;">å‰© ${bufferLiq.toFixed(0)}%</span>
            </div>
        </div>
    `;
    t(`status_${id}`, statusHtml);

    const factor = 1 - (dropPct / 100);
    const simAsset = asset * factor;
    let simTxt = "å®‰å…¨";
    let simCls = "b-safe";
    let simRatioVal = 0;
    let topUpNeeded = 0;

    if(!isEtf) {
        simRatioVal = simAsset>0 ? loan/simAsset*100 : 0;
        if(simRatioVal >= liqLimit) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
        else if(simRatioVal >= mcLimit) { simTxt = "è£œç¹³"; simCls = "b-warn"; }
        if (simRatioVal > mcLimit) {
            const maxLoanAllowed = simAsset * (mcLimit / 100);
            topUpNeeded = loan - maxLoanAllowed;
        }
    } else {
        const simMaint = loan>0 ? simAsset/loan*100 : 0;
        if(loan>0) {
            if(simMaint < 115) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
            else if(simMaint < 130) { simTxt = "è¿½ç¹³"; simCls = "b-warn"; }
            if (simMaint < 130) {
                const targetLoan = simAsset / 1.3;
                topUpNeeded = loan - targetLoan;
            }
        }
    }

    // Display simulated ratio/maint
    let simDisp = "";
    if(isEtf) {
         simDisp = loan>0 ? (simAsset/loan*100).toFixed(0)+"%" : "-";
    } else {
         simDisp = simRatioVal.toFixed(1)+"%";
    }

    let topUpHtml = "";
    if (topUpNeeded > 0) topUpHtml = `<div style="font-size:0.8rem; color:var(--c-danger); margin-top:2px; font-weight:bold;">ğŸ’¸ éœ€è£œ ${topUpNeeded.toFixed(1)} è¬</div>`;

    const simHtml = `
        <div style="font-weight:bold; font-size:0.9rem;" class="privacy-blur">${simAsset.toFixed(0)} <small style="color:var(--text-sub)">è¬</small></div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.8rem;">
            <span>${simDisp}</span>
            <span class="badge ${simCls}">${simTxt}</span>
        </div>
        ${topUpHtml}
    `;
    t(`sim_res_${id}`, simHtml);

    return { interest, bufferMC, bufferLiq, name: id, divAcc, loan, asset };
  }

  // AI Advice
  function generateAI(netWorth, surplus, debtRatio, minBufferObj, totalAsset, totalDebt, investDebt, lifeDebt, totalLiquidity, monthlyExpense) {
    let msg = "";
    let detailsHtml = "";

    const monthsSurvival = monthlyExpense > 0 ? totalLiquidity / monthlyExpense : 0;
    if (monthsSurvival >= 6) msg += `<div style="margin-bottom:8px;">ğŸ’§ <b>æµå‹•æ€§å……è£•ï¼š</b> å‚™ç”¨é‡‘ <b>${totalLiquidity.toLocaleString()}è¬</b>ï¼Œç´„å¯æ”¯æ’ <b>${monthsSurvival.toFixed(1)}å€‹æœˆ</b> é–‹éŠ·ï¼Œå®‰å…¨æ°£å›Šè¶³å¤ ã€‚</div>`;
    else if (monthsSurvival >= 3) msg += `<div style="margin-bottom:8px;">ğŸ’§ <b>æµå‹•æ€§å°šå¯ï¼š</b> å‚™ç”¨é‡‘å¯æ”¯æ’ <b>${monthsSurvival.toFixed(1)}å€‹æœˆ</b>ï¼Œå»ºè­°è£œè¶³è‡³ 6 å€‹æœˆä»¥æ‡‰å°çªç™¼ç‹€æ³ã€‚</div>`;
    else msg += `<div style="margin-bottom:8px;">âš ï¸ <b>æµå‹•æ€§åƒç·Šï¼š</b> å‚™ç”¨é‡‘åƒ…å¤  <b>${monthsSurvival.toFixed(1)}å€‹æœˆ</b>ï¼Œé¢¨éšªæ¥µé«˜ï¼å»ºè­°å„ªå…ˆä¿ç•™ç¾é‡‘ã€‚</div>`;

    const bufferDesc = minBufferObj.val > 20 ? 
        `<span style='color:var(--c-safe)'>å®‰å…¨å……è¶³ (>20%)</span>` : 
        (minBufferObj.val > 10 ? `<span style='color:var(--c-warn)'>ç•™æ„æ³¢å‹• (<20%)</span>` : `<span style='color:var(--c-danger)'>å±éšª (<10%)</span>`);
    msg += `<div style="margin-bottom:8px;">ğŸ›¡ï¸ <b>è³‡ç”¢å®‰å…¨ï¼š</b> æœ€è„†å¼±è³‡ç”¢ç‚º <b>${minBufferObj.name.toUpperCase()}</b>ï¼ŒæŠ—è·Œç©ºé–“ ${bufferDesc}ã€‚</div>`;
    
    const levDesc = debtRatio > 60 ? `<span style='color:var(--c-warn)'>åé«˜ (${debtRatio.toFixed(1)}%)</span>` : `<span style='color:var(--c-safe)'>å¥åº· (${debtRatio.toFixed(1)}%)</span>`;
    msg += `<div style="margin-bottom:8px;">âš–ï¸ <b>æ§“æ¡¿è©•ä¼°ï¼š</b> æ•´é«”è² å‚µæ¯” ${levDesc}ã€‚ä¸»è¦æ˜¯æˆ¿è²¸èˆ‡ä¿¡è²¸æ¨å‡äº†æ¯”ç‡ã€‚</div>`;

    const cashDesc = surplus > 0 ? `<span style='color:var(--c-safe)'>æ­£å‘å¥åº· (+${surplus.toFixed(1)}è¬)</span>` : `<span style='color:var(--c-danger)'>èµ¤å­—è­¦ç¤º (${surplus.toFixed(1)}è¬)</span>`;
    msg += `<div>ğŸ’° <b>ç¾é‡‘æµï¼š</b> æ¯æœˆçµé¤˜ ${cashDesc}ã€‚è«‹ç¢ºä¿è¢«å‹•æ”¶å…¥æŒçºŒå¤§æ–¼åˆ©æ¯æ”¯å‡ºã€‚</div>`;

    detailsHtml += `<details><summary>ğŸ’¡ æ‚¨çš„ã€Œç¸½å¯å‹•ç”¨å‚™ç”¨é‡‘ã€æ˜¯æ€éº¼ç®—çš„ï¼Ÿ</summary><p>ç³»çµ±å°‡æ‚¨çš„<br>1. æ‰‹é ­ç¾é‡‘ (${v('asset_cash')}è¬)<br>2. æœªç”¨å¾ªç’°ä¿¡è²¸ (${v('unused_credit')}è¬)<br>3. æœªç”¨è³ªæŠ¼é¡åº¦ (${v('unused_pledge')}è¬)<br>åŠ ç¸½å¾—åˆ° <b>${totalLiquidity}è¬</b>ã€‚<br>é€™ç­†éŒ¢æ˜¯ç”¨ä¾†æ•‘æ€¥ï¼ˆå¦‚å¤±æ¥­ã€è‚¡ç½è£œç¹³ï¼‰çš„æ•‘å‘½éŒ¢ã€‚</p></details>`;
    detailsHtml += `<details><summary>ğŸ’¡ ${debtRatio.toFixed(1)}% çš„æ§“æ¡¿ç‡æ˜¯æŒ‡ä»€éº¼ï¼Ÿ</summary><p>å…¬å¼ï¼š<span class="highlight-val">ç¸½è² å‚µ (${totalDebt.toLocaleString()}è¬) Ã· ç¸½è³‡ç”¢ (${totalAsset.toLocaleString()}è¬)</span><br><br>æ‚¨çš„ç¸½è² å‚µåŒ…å«ï¼š<br>1. æŠ•è³‡å€Ÿæ¬¾ï¼š${investDebt.toLocaleString()} è¬<br>2. ç”Ÿæ´»è² å‚µï¼ˆæˆ¿è²¸/ä¿¡è²¸ï¼‰ï¼š${lifeDebt.toLocaleString()} è¬<br>AI å»ºè­°å„ªå…ˆå„Ÿé‚„<b>ä¿¡è²¸</b>ã€‚</p></details>`;

    document.getElementById('ai_advice_content').innerHTML = msg;
    document.getElementById('ai_explained_container').innerHTML = detailsHtml;
  }

  function calc() {
    let policyTotalInterest = 0;
    let etfTotalInterest = 0;
    let minBuffer = 100;
    let minBufferName = "ç„¡";
    let totalDividends = 0;
    
    const processRisk = (res) => {
        if (res.bufferMC < minBuffer && res.bufferMC >= 0 && res.name !== 'e') { 
            minBuffer = res.bufferMC;
            minBufferName = res.name;
        }
        totalDividends += res.divAcc;
        return res.interest;
    };

    const rA = renderAssetStatus('a', v('asset_a'), v('loan_a'), v('cost_a'), 80, 90, false);
    const rB = renderAssetStatus('b', v('asset_b'), v('loan_b'), v('cost_b'), 80, 90, false);
    const rC = renderAssetStatus('c', v('asset_c'), v('loan_c'), v('cost_c'), 80, 90, false);
    const rD = renderAssetStatus('d', v('asset_d'), v('loan_d'), v('cost_d'), 60, 70, false);
    const rE = renderAssetStatus('e', v('asset_e'), v('loan_e'), v('cost_e'), 80, 90, false, true);
    const rETF = renderAssetStatus('etf', v('asset_etf'), v('loan_etf'), v('cost_etf'), 0, 0, true);

    policyTotalInterest = processRisk(rA) + processRisk(rB) + processRisk(rC) + processRisk(rD) + processRisk(rE);
    etfTotalInterest = processRisk(rETF);

    t('disp_policy_interest', policyTotalInterest.toFixed(2));
    t('disp_etf_interest', etfTotalInterest.toFixed(2));
    const totalInvestInterest = policyTotalInterest + etfTotalInterest;

    const investAsset = v('asset_a')+v('asset_b')+v('asset_c')+v('asset_d')+v('asset_e')+v('asset_etf');
    const investDebt = v('loan_a')+v('loan_b')+v('loan_c')+v('loan_d')+v('loan_e')+v('loan_etf');
    const investCost = v('cost_a')+v('cost_b')+v('cost_c')+v('cost_d')+v('cost_e')+v('cost_etf');
    const houseVal = v('asset_house');
    const houseDebt = v('debt_house');
    const personalDebt = v('debt_personal');
    const cash = v('asset_cash');

    const totalAssets = investAsset + houseVal + cash;
    const totalLiabilities = investDebt + houseDebt + personalDebt;
    const netWorth = totalAssets - totalLiabilities;

    t('val_net_worth', netWorth.toLocaleString());
    t('val_assets', totalAssets.toLocaleString());
    t('val_liabilities', totalLiabilities.toLocaleString());
    t('val_invest_assets', investAsset.toLocaleString());
    t('val_cost', investCost.toLocaleString());
    t('val_total_div', totalDividends.toLocaleString()); 
    
    const pl = (investAsset + totalDividends) - investCost;
    const elPl = document.getElementById('val_pl');
    elPl.innerText = (pl>0?"+":"") + pl.toLocaleString();
    elPl.style.color = pl>=0 ? "var(--c-safe)" : "var(--c-danger)";

    t('val_invest_debt', investDebt.toLocaleString());
    t('val_life_debt', (houseDebt+personalDebt).toLocaleString());
    
    const debtRatio = totalAssets>0 ? (totalLiabilities/totalAssets*100) : 0;
    t('val_debt_ratio', debtRatio.toFixed(1)+"%");

    const incAct = v('inc_active');
    const incPas = v('inc_passive');
    const inc = incAct + incPas;
    t('disp_inc_total', inc.toFixed(2));
    t('val_income', inc.toFixed(1));

    const expFix = v('exp_house') + v('exp_personal') + v('exp_life') + v('exp_flex');
    const totalExp = expFix + totalInvestInterest;
    t('disp_exp_total', totalExp.toFixed(2));
    t('val_expense', totalExp.toFixed(1));

    const surplus = inc - totalExp;
    t('val_surplus', surplus.toFixed(2));
    
    const surBig = document.getElementById('disp_surplus_big');
    surBig.innerText = (surplus>0?"+":"") + surplus.toFixed(2) + " è¬";
    surBig.style.color = surplus>=0 ? "var(--c-safe)" : "var(--c-danger)";
    t('surplus_msg', surplus>=0 ? "è²¡å‹™å¥åº·" : "ç¾é‡‘æµèµ¤å­—");

    const unusedCredit = v('unused_credit');
    const unusedPledge = v('unused_pledge');
    const totalLiquidity = cash + unusedCredit + unusedPledge;
    t('total_liquidity_display', `ç¸½å¯å‹•ç”¨å‚™ç”¨é‡‘: ${totalLiquidity} è¬`);

    updateCharts([investAsset, houseVal, cash], [incAct, incPas, totalExp]);
    generateAI(netWorth, surplus, debtRatio, { val: minBuffer, name: minBufferName }, totalAssets, totalLiabilities, investDebt, (houseDebt+personalDebt), totalLiquidity, totalExp);
  }

  function initCharts() {
    chartAsset = new Chart(document.getElementById('assetChart'), {
        type: 'doughnut',
        data: {
            labels: ['æŠ•è³‡', 'æˆ¿ç”¢', 'ç¾é‡‘'],
            datasets: [{ data: [1, 1, 1], backgroundColor: ['#8b5cf6', '#f97316', '#10b981'], borderWidth: 0 }]
        },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%' }
    });

    chartFlow = new Chart(document.getElementById('flowChart'), {
        type: 'bar',
        data: {
            labels: ['æ”¶æ”¯'],
            datasets: [
                { label: 'ä¸»å‹•', data: [0], backgroundColor: '#3b82f6', stack: 'Income' },
                { label: 'è¢«å‹•', data: [0], backgroundColor: '#eab308', stack: 'Income' },
                { label: 'æ”¯å‡º', data: [0], backgroundColor: '#ef4444', stack: 'Expense' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
    });
  }

  function updateCharts(assets, flows) {
    if(chartAsset) { chartAsset.data.datasets[0].data = assets; chartAsset.update(); }
    if(chartFlow) { chartFlow.data.datasets[0].data = [flows[0]]; chartFlow.data.datasets[1].data = [flows[1]]; chartFlow.data.datasets[2].data = [flows[2]]; chartFlow.update(); }
  }

  function togglePrivacy() {
    document.body.classList.toggle('privacy-mode');
    const btn = document.getElementById('btnPrivacy');
    if(document.body.classList.contains('privacy-mode')) {
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> é¡¯ç¤ºé‡‘é¡';
        btn.classList.add('active');
    } else {
        btn.innerHTML = '<i class="fas fa-eye"></i> éš±è—é‡‘é¡';
        btn.classList.remove('active');
    }
  }

  function exportPDF() {
    const el = document.getElementById('dashboard-container');
    const opt = {
        margin: 5,
        filename: 'è²¡å‹™å ±å‘Š.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS:true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    alert("æ­£åœ¨ç”¢ç”Ÿ PDF (A4 ç›´å¼)ï¼Œè«‹ç¨å€™...");
    html2pdf().set(opt).from(el).save();
  }

  function saveData() {
    const d = {};
    document.querySelectorAll('input').forEach(e => d[e.id] = e.value);
    localStorage.setItem('wcj_final_v22_complete', JSON.stringify(d));
    alert('å·²å„²å­˜');
  }
  function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'); }

  window.onload = () => {
    initCharts();
    const d = JSON.parse(localStorage.getItem('wcj_final_v22_complete'));
    if(d) for(k in d) if(document.getElementById(k)) document.getElementById(k).value=d[k];
    calc();
  };
</script>
</body>
</html>
