<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿ (Pro Strategy Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- æ ¸å¿ƒå‡½å¼åº« -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-sub: #64748b;
      
      --c-safe: #10b981;    /* ç¶  */
      --c-warn: #f59e0b;    /* æ©˜ */
      --c-danger: #ef4444;  /* ç´… */
      --c-blue: #3b82f6;
      --c-purple: #8b5cf6;
      --c-gold: #eab308;
      
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f8fafc;
      --text-sub: #94a3b8;
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; transition: 0.3s; }
    
    #dashboard-container { max-width: 1600px; margin: 0 auto; padding-bottom: 50px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
    .btn-group button { background: var(--bg-card); border: 1px solid var(--text-sub); color: var(--text-main); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight:bold; transition:0.2s; font-size: 0.85rem; display:flex; align-items:center; gap:6px; }
    .btn-group button:hover { background: var(--c-blue); color: white; border-color: var(--c-blue); transform:translateY(-1px); }
    .btn-backup { border-color: var(--c-purple) !important; color: var(--c-purple) !important; }
    .btn-pdf { border-color: var(--c-danger) !important; color: var(--c-danger) !important; }
    .btn-privacy { border-color: var(--text-main) !important; }
    .btn-privacy.active { background: var(--text-main); color: var(--bg-card); }

    /* Hero Grid */
    .hero-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .hero-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border-top: 4px solid var(--c-blue); position: relative; overflow: hidden; }
    .hero-title { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; display:flex; align-items:center; gap:5px; }
    .hero-val { font-size: 1.8rem; font-weight: 800; position: relative; z-index: 2; }
    .hero-sub { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; line-height: 1.4; position: relative; z-index: 2; }
    .hero-icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.05; transform: rotate(-15deg); z-index: 1; }

    /* FIRE Progress Bar */
    .fire-track { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 8px; overflow: hidden; }
    .fire-fill { height: 100%; background: linear-gradient(90deg, var(--c-gold), var(--c-orange)); border-radius: 4px; width: 0%; transition: width 1s ease; }

    /* Charts Grid */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); height: 380px; display: flex; flex-direction: column; }
    .chart-box { flex: 1; position: relative; width: 100%; overflow: hidden; }

    /* Control Zone */
    .control-zone { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--c-danger); }
    .control-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .control-group h3 { margin: 0 0 10px 0; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    
    .range-wrap { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    input[type=range] { flex: 1; height: 6px; border-radius: 5px; background: #cbd5e1; outline: none; -webkit-appearance: none; }
    #sim_slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--c-danger); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    #rate_slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--c-blue); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    .history-btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .h-btn { padding: 6px 12px; border: 1px solid #e2e8f0; background: var(--bg-card); border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; display: flex; align-items: center; gap: 4px; color: var(--text-sub); }
    .h-btn:hover { border-color: var(--c-danger); color: var(--c-danger); background: rgba(239, 68, 68, 0.05); transform: translateY(-1px); }

    .crash-detail-box { margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.05); border-radius: 6px; font-size: 0.85rem; line-height: 1.5; display: none; color: var(--text-main); }

    /* Main Content */
    .main-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
    .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
    .section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--bg-body); display: flex; justify-content: space-between; align-items: center; }

    /* Table */
    .table-container { overflow-x: auto; }
    .asset-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 950px; }
    .asset-table th { text-align: left; padding: 10px; color: var(--text-sub); border-bottom: 2px solid var(--bg-body); white-space: nowrap; }
    .asset-table td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    
    /* Inputs */
    .inp-group { display: flex; flex-direction: column; gap: 5px; }
    input[type="number"] { width: 95px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-weight: 600; background: var(--bg-body); color: var(--text-main); }
    input.sm { width: 60px; font-size: 0.85rem; }
    input[type="date"] { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.75rem; width: 100%; background: transparent; color: var(--text-main); }

    /* Visual Elements */
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; display: inline-block; }
    .b-safe { background: rgba(16,185,129,0.15); color: var(--c-safe); }
    .b-warn { background: rgba(245,158,11,0.15); color: var(--c-warn); }
    .b-danger { background: rgba(239,68,68,0.15); color: var(--c-danger); }
    .rule-tag { font-size: 0.75rem; color: var(--text-sub); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; border: 1px solid #e2e8f0; font-weight: 600; }
    
    .water-track { position: relative; width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 8px; overflow: hidden; }
    .water-fill { height: 100%; background: var(--c-safe); border-radius: 5px; transition: width 0.5s ease; }
    .water-mark { position: absolute; top: 0; bottom: 0; width: 2px; z-index: 2; }
    .mark-mc { background: var(--c-warn); }
    .mark-liq { background: var(--c-danger); }
    
    /* ROI */
    .roi-wrapper { margin-top:6px; font-size:0.75rem; display:flex; flex-direction:column; gap:3px; border-top:1px dashed #eee; padding-top:4px; }
    .roi-row { display:flex; justify-content:space-between; }
    .roi-val { font-weight:bold; font-family: monospace;}
    .c-up { color: var(--c-safe); }
    .c-down { color: var(--c-danger); }

    /* Side Panel Summary */
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .total-line { border-top: 2px solid #eee; padding-top: 10px; margin-top: 5px; font-size: 1.1rem; font-weight: bold; }

    /* Notes Box */
    .notes-box { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border: 1px solid #bfdbfe; padding: 20px; border-radius: 12px; margin-top: 20px; position: relative; }
    .notes-title { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--c-blue); font-size: 1.1rem; margin-bottom: 10px; }
    
    /* UPDATED: Larger Textarea */
    textarea.custom-notes { 
        width:100%; 
        min-height: 450px; /* Increased height */
        padding:15px; 
        border:1px solid #bfdbfe; 
        border-radius:8px; 
        font-family:'Segoe UI', sans-serif; 
        font-size:0.95rem; 
        line-height:1.7; 
        resize:vertical; 
        background:rgba(255,255,255,0.8); 
        color: var(--text-main); 
    }
    textarea.custom-notes:focus { border-color: var(--c-blue); background:#fff; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* Privacy Mode */
    body.privacy-mode input[type="number"],
    body.privacy-mode .privacy-blur,
    body.privacy-mode .roi-val {
        color: transparent !important;
        text-shadow: 0 0 8px rgba(0,0,0,0.5);
        cursor: default;
    }
    body.privacy-mode input[type="number"]:focus {
        color: var(--text-main) !important;
        text-shadow: none;
    }

    @media (max-width: 1200px) {
      .hero-grid { grid-template-columns: 1fr 1fr; }
      .charts-grid, .control-layout, .main-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container" id="dashboard-container">
  
  <!-- Header -->
  <div class="header">
    <div>
      <h1 style="margin:0; color:var(--c-blue)"><i class="fas fa-university"></i> è²¡å‹™è‡ªç”±çµ‚æ¥µå„€è¡¨æ¿</h1>
      <span style="font-size:0.85rem; color:var(--text-sub)">Pro Strategy Edition: åŒ…å«å°ˆæ¥­ç†è²¡å»ºè­°</span>
    </div>
    <div class="btn-group" data-html2canvas-ignore="true">
      <button onclick="togglePrivacy()" id="btnPrivacy" class="btn-privacy"><i class="fas fa-eye"></i> éš±è—é‡‘é¡</button>
      <button onclick="toggleTheme()"><i class="fas fa-adjust"></i> æ¨¡å¼</button>
      <button onclick="exportJSON()" class="btn-backup"><i class="fas fa-download"></i> å‚™ä»½(JSON)</button>
      <button onclick="document.getElementById('importFile').click()" class="btn-backup" style="border-style:dashed"><i class="fas fa-upload"></i> é‚„åŸ</button>
      <button onclick="saveData()"><i class="fas fa-save"></i> æœ¬åœ°å­˜æª”</button>
      <button onclick="calc()"><i class="fas fa-sync"></i> é‡ç®—</button>
      <button onclick="exportPDF()" class="btn-pdf"><i class="fas fa-file-pdf"></i> åŒ¯å‡º PDF</button>
      <input type="file" id="importFile" style="display:none" onchange="importJSON(this)">
    </div>
  </div>

  <!-- 1. æ ¸å¿ƒæ•¸æ“š (Hero) -->
  <div class="hero-grid">
    <div class="hero-card">
      <div class="hero-title"><i class="fas fa-sack-dollar"></i> çœŸå¯¦æ·¨è³‡ç”¢</div>
      <div class="hero-val privacy-blur" style="color:var(--c-blue)"><span id="val_net_worth">0</span> è¬</div>
      <div class="hero-sub">ç¸½è³‡ç”¢ <span id="val_assets" class="privacy-blur">0</span> ï¼ ç¸½è² å‚µ <span id="val_liabilities" class="privacy-blur">0</span><br>(å«æˆ¿è²¸/ä¿¡è²¸æœ¬é‡‘)</div>
      <i class="fas fa-chart-pie hero-icon-bg" style="color:var(--c-blue)"></i>
    </div>
    
    <div class="hero-card" style="border-top-color: var(--c-safe);">
      <div class="hero-title"><i class="fas fa-hand-holding-dollar"></i> æ¯æœˆæ·¨ç¾é‡‘æµ</div>
      <div class="hero-val privacy-blur" style="color:var(--c-safe)">+<span id="val_surplus">0</span> è¬</div>
      <div class="hero-sub">æœˆæ”¶ <span id="val_income" class="privacy-blur">0</span> ï¼ æœˆæ”¯ <span id="val_expense" class="privacy-blur">0</span><br>(å·²è‡ªå‹•æ‰£é™¤æŠ•è³‡åˆ©æ¯)</div>
      <i class="fas fa-coins hero-icon-bg" style="color:var(--c-safe)"></i>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-gold);">
      <div class="hero-title"><i class="fas fa-fire"></i> FIRE é€€ä¼‘é€²åº¦</div>
      <div style="display:flex; justify-content:space-between; align-items:end;">
          <div class="hero-val privacy-blur" style="color:var(--c-gold)" id="fire_pct">0%</div>
          <div style="font-size:0.8rem; color:var(--text-sub); display:flex; align-items:center;">
              ç›®æ¨™: <input type="number" id="fire_target" value="3000" oninput="calc()" style="width:60px; border:none; border-bottom:1px dashed #ccc; background:transparent;"> è¬
          </div>
      </div>
      <div class="fire-track"><div id="fire_bar" class="fire-fill" style="background:var(--c-gold)"></div></div>
      <div class="hero-sub" style="margin-top:5px;">é‚„å·® <span id="fire_diff" class="privacy-blur">0</span> è¬</div>
      <i class="fas fa-flag-checkered hero-icon-bg" style="color:var(--c-gold)"></i>
    </div>

    <div class="hero-card" style="border-top-color: var(--c-purple);">
      <div class="hero-title"><i class="fas fa-chart-line"></i> æŠ•è³‡ç¸½æç›Š (å«æ¯)</div>
      <div class="hero-val privacy-blur"><span id="val_pl">0</span> è¬</div>
      <div class="hero-sub">ç¸½æŠ•å…¥ <span id="val_cost" class="privacy-blur">0</span> ï½œ ç¾å€¼ <span id="val_invest_assets" class="privacy-blur">0</span><br>ç´¯ç©é…æ¯ <span id="val_total_div" class="privacy-blur">0</span></div>
      <i class="fas fa-arrow-trend-up hero-icon-bg" style="color:var(--c-purple)"></i>
    </div>
  </div>

  <!-- 2. åœ–è¡¨å€ (Charts) -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;"><i class="fas fa-chart-pie"></i> è³‡ç”¢é…ç½® (å«æˆ¿ç”¢)</h3>
      <div class="chart-box"><canvas id="assetChart"></canvas></div>
    </div>
    <div class="chart-card">
      <h3 style="margin:0 0 10px 0; font-size:1rem;"><i class="fas fa-bars-progress"></i> æ”¶æ”¯çµæ§‹ (å †ç–Šåˆ†æ)</h3>
      <div class="chart-box"><canvas id="flowChart"></canvas></div>
    </div>
  </div>

  <!-- 3. å£“åŠ›æ¸¬è©¦æ§åˆ¶å° -->
  <div class="control-zone">
    <div class="control-layout">
        <!-- è‚¡ç½æ¨¡æ“¬ -->
        <div class="control-group">
            <h3 style="color:var(--c-danger)"><i class="fas fa-chart-down"></i> è‚¡ç½å£“åŠ›æ¸¬è©¦</h3>
            <div class="range-wrap">
                <span style="font-size:0.8rem; width:40px;">è·Œå¹…</span>
                <input type="range" id="sim_slider" min="0" max="60" step="1" value="0" oninput="manualSlider()">
                <span style="font-size:0.9rem; font-weight:bold; color:var(--c-danger); width:50px;" id="sim_label">0%</span>
            </div>
            
            <div class="history-btns">
                <button class="h-btn" onclick="setHistoryCrash(49, 25, '2000 ç¶²è·¯æ³¡æ²«', 'ç§‘æŠ€è‚¡å´©ç›¤ï¼ŒETFè·Œ49%ï¼Œä¿å–®(å¹³è¡¡)è·Œ25%')">ğŸ“‰ 2000 æ³¡æ²«</button>
                <button class="h-btn" onclick="setHistoryCrash(57, 35, '2008 é‡‘èæµ·å˜¯', 'ç³»çµ±æ€§å´©ç›¤ï¼ŒETFè·Œ57%ï¼Œä¿å–®è·Œ35%')">âš¡ 2008 æµ·å˜¯</button>
                <button class="h-btn" onclick="setHistoryCrash(34, 20, '2020 æ–°å† ç–«æƒ…', 'ææ…Œæ€§ä¸‹æ®ºï¼ŒETFè·Œ34%ï¼Œä¿å–®è·Œ20%')">ğŸ¦  2020 ç–«æƒ…</button>
                <button class="h-btn" onclick="resetSim()" style="color:var(--c-blue); border-color:var(--c-blue)">ğŸ”„ é‡ç½®</button>
            </div>
            
            <div id="crash_detail" class="crash-detail-box">
                <span id="crash_title" class="crash-title" style="font-weight:bold;"></span><br>
                <span id="crash_desc"></span>
            </div>
        </div>

        <!-- å‡æ¯æ¨¡æ“¬ -->
        <div class="control-group" style="border-left:1px solid #eee; padding-left:20px;">
            <h3 style="color:var(--c-blue)"><i class="fas fa-money-bill-trend-up"></i> å‡æ¯ç¾é‡‘æµæ¸¬è©¦</h3>
            <div class="range-wrap">
                <span style="font-size:0.8rem; width:40px;">åŠ æ¯</span>
                <input type="range" id="rate_slider" min="0" max="3" step="0.125" value="0" style="accent-color:var(--c-blue)" oninput="calc()">
                <span style="font-size:0.9rem; font-weight:bold; color:var(--c-blue); width:50px;" id="rate_label">+0.0%</span>
            </div>
            <div style="font-size:0.8rem; color:var(--text-sub); margin-top:10px;">
                <i class="fas fa-info-circle"></i> æ¸¬è©¦å¤®è¡Œå‡æ¯å°æˆ¿è²¸ã€ä¿¡è²¸åŠæŠ•è³‡åˆ©æ¯çš„è¡æ“Šã€‚<br>
                è«‹è§€å¯Ÿå³ä¸‹è§’ã€Œæœˆæ”¯å‡ºã€çš„è®ŠåŒ–ã€‚
            </div>
        </div>
    </div>
  </div>

  <!-- 4. ä¸‹å±¤è³‡æ–™å€ -->
  <div class="main-layout">
    <!-- å·¦å´ -->
    <div class="main-content">
      <div class="section-card">
        <div class="section-title"><span><i class="fas fa-shield-alt"></i> è³‡ç”¢æŒæœ‰èˆ‡é¢¨éšªè©³è¡¨</span></div>
        <div class="table-container">
          <table class="asset-table">
            <thead>
              <tr>
                <th style="width:22%">é …ç›® / æŒæœ‰æ™‚é–“</th>
                <th>ç¾å€¼ / æˆæœ¬ / ç´¯ç©é…æ¯</th>
                <th>å€Ÿæ¬¾ / åˆ©ç‡(%)</th>
                <th style="width:28%; background:rgba(59,130,246,0.02)">é¢¨éšªç¾æ³ (æ°´ä½åœ–)</th>
                <th style="width:18%; background:rgba(239,68,68,0.05)">æ¨¡æ“¬çµæœ (è£œç¹³è©¦ç®—)</th>
              </tr>
            </thead>
            <tbody>
              <!-- ä¿å–® A -->
              <tr>
                <td><b>ä¿å–® A</b> (æ³•å·´å¹´é‡‘)<br><span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span><div class="date-wrapper"><input type="date" id="date_a" value="2024-09-01" onchange="calc()"><div id="dur_a" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_a" type="number" value="47.7" oninput="calc()"><input id="cost_a" type="number" value="50" oninput="calc()" style="opacity:0.7"><input id="div_a" type="number" value="4.4" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_a"></div></td>
                <td><div class="inp-group"><input id="loan_a" type="number" value="21.5" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_a" type="number" value="3.17" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_a"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_a"></div></td>
              </tr>
              <!-- ä¿å–® B -->
              <tr>
                <td><b>ä¿å–® B</b> (æ³•å·´å£½éšª)<br><span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span><div class="date-wrapper"><input type="date" id="date_b" value="2024-10-01" onchange="calc()"><div id="dur_b" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_b" type="number" value="147.8" oninput="calc()"><input id="cost_b" type="number" value="150" oninput="calc()" style="opacity:0.7"><input id="div_b" type="number" value="13.2" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_b"></div></td>
                <td><div class="inp-group"><input id="loan_b" type="number" value="68.5" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_b" type="number" value="3.17" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_b"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_b"></div></td>
              </tr>
              <!-- ä¿å–® C -->
              <tr>
                <td><b>ä¿å–® C</b> (å®‰é”å¹´é‡‘)<br><span class="rule-tag">è£œç¹³80% / æ–·é ­90%</span><div class="date-wrapper"><input type="date" id="date_c" value="2025-09-01" onchange="calc()"><div id="dur_c" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_c" type="number" value="180" oninput="calc()"><input id="cost_c" type="number" value="173" oninput="calc()" style="opacity:0.7"><input id="div_c" type="number" value="3.3" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_c"></div></td>
                <td><div class="inp-group"><input id="loan_c" type="number" value="84" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_c" type="number" value="4.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_c"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_c"></div></td>
              </tr>
              <!-- ä¿å–® D -->
              <tr>
                <td><b>ä¿å–® D</b> (å®‰è¯ä¸»åŠ›)<br><span class="rule-tag">è£œç¹³60% / æ–·é ­70%</span><div class="date-wrapper"><input type="date" id="date_d" value="2025-07-01" onchange="calc()"><div id="dur_d" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_d" type="number" value="328" oninput="calc()"><input id="cost_d" type="number" value="303" oninput="calc()" style="opacity:0.7"><input id="div_d" type="number" value="9.8" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_d"></div></td>
                <td><div class="inp-group"><input id="loan_d" type="number" value="90" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_d" type="number" value="4.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_d"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_d"></div></td>
              </tr>
              <!-- ä¿å–® E -->
              <tr>
                <td><b>ä¿å–® E</b> (é é›„äººå£½)<br><span class="rule-tag" style="background:#ecfccb;color:#365314;border-color:#bef264;">å„²è“„å‹ / ç„¡è‚¡å¸‚é¢¨éšª</span><div class="date-wrapper"><input type="date" id="date_e" onchange="calc()"><div id="dur_e" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_e" type="number" value="15" oninput="calc()"><input id="cost_e" type="number" value="15" oninput="calc()" style="opacity:0.7"><input id="div_e" type="number" value="0" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_e"></div></td>
                <td><div class="inp-group"><input id="loan_e" type="number" value="8" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_e" type="number" value="3.1" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_e"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_e"></div></td>
              </tr>
              <!-- ETF -->
              <tr style="background:rgba(59,130,246,0.03)">
                <td><b>å°è‚¡ ETF</b> (è³ªæŠ¼)<br><span class="rule-tag">è¿½ç¹³ 130% / æ–·é ­ 115%</span><div class="date-wrapper"><input type="date" id="date_etf" onchange="calc()"><div id="dur_etf" style="font-size:0.7rem;color:var(--c-blue)"></div></div></td>
                <td><div class="inp-group"><input id="asset_etf" type="number" value="171" oninput="calc()"><input id="cost_etf" type="number" value="175" oninput="calc()" style="opacity:0.7"><input id="div_etf" type="number" value="12.6" oninput="calc()" style="border-color:var(--c-gold)"></div><div id="roi_etf"></div></td>
                <td><div class="inp-group"><input id="loan_etf" type="number" value="34.5" oninput="calc()"><div style="display:flex;align-items:center;gap:2px;"><input id="rate_etf" type="number" value="3.0" class="sm" oninput="calc()"><span style="font-size:0.7rem">%</span></div></div></td>
                <td style="background:rgba(59,130,246,0.02)"><div id="status_etf"></div></td>
                <td style="background:rgba(239,68,68,0.02)"><div id="sim_res_etf"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="section-card">
        <div class="section-title">ğŸ  æˆ¿ç”¢èˆ‡ç”Ÿæ´»è² å‚µ (æœ¬é‡‘æ­¸æˆ¶)</div>
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;"><h4 style="margin:0 0 5px 0; color:var(--text-sub); font-size:0.9rem;">æˆ¿ç”¢ä¼°å€¼</h4><input id="asset_house" type="number" value="470" oninput="calc()" style="width:100%; border-color:var(--c-blue)"></div>
            <div style="flex:1; min-width:200px;">
                <h4 style="margin:0 0 5px 0; color:var(--text-sub); font-size:0.9rem;">æ¬ æ¬¾æœ¬é‡‘</h4>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label style="font-size:0.8rem">æˆ¿è²¸é¤˜é¡</label><input id="debt_house" type="number" value="460.4" oninput="calc()" style="width:100%"></div>
                    <div style="flex:1"><label style="font-size:0.8rem">ä¿¡è²¸é¤˜é¡</label><input id="debt_personal" type="number" value="95.6" oninput="calc()" style="width:100%"></div>
                </div>
            </div>
            <div style="flex:1; min-width:250px;">
                <h4 style="margin:0 0 5px 0; color:var(--c-safe); font-size:0.9rem;">æµå‹•æ€§èˆ‡å‚™ç”¨é‡‘</h4>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1"><label style="font-size:0.7rem">æ‰‹é ­ç¾é‡‘</label><input id="asset_cash" type="number" value="40" oninput="calc()" style="width:100%; border-color:var(--c-safe)"></div>
                    <div style="flex:1"><label style="font-size:0.7rem">æœªç”¨ä¿¡è²¸</label><input id="unused_credit" type="number" value="36" oninput="calc()" style="width:100%"></div>
                    <div style="flex:1"><label style="font-size:0.7rem">æœªç”¨è³ªæŠ¼</label><input id="unused_pledge" type="number" value="50" oninput="calc()" style="width:100%"></div>
                </div>
                <div id="total_liquidity_display" style="font-size:0.8rem; color:var(--c-safe); margin-top:5px; text-align:right; font-weight:bold;"></div>
            </div>
        </div>
      </div>
      
      <!-- ç­–ç•¥ç­†è¨˜èˆ‡å‚™è¨» -->
      <div class="notes-box">
        <div class="notes-title"><i class="fas fa-clipboard-list"></i> ç­–ç•¥ç­†è¨˜èˆ‡å‚™è¨» (AI å»ºè­°å€)</div>
        <textarea id="user_notes" class="custom-notes" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç†è²¡ç­–ç•¥...">ã€è²¡å‹™å¥æª¢èˆ‡æ“ä½œå»ºè­° - 2025/12 Updatedã€‘

1. è²¡å‹™ç¾æ³å¿«ç¯©ï¼šé«˜æ§“æ¡¿ä¸‹çš„ã€Œç¾é‡‘æµã€ä¿è¡›æˆ°
æ‚¨çš„è³‡ç”¢å¢é•·æ ¸å¿ƒåœ¨æ–¼ã€Œæ§“æ¡¿å¥—åˆ©ã€ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæ·¨è³‡ç”¢ (Net Worth) åªæ˜¯åƒè€ƒï¼Œç¾é‡‘æµ (Cash Flow) æ‰æ˜¯ç”Ÿå­˜é—œéµã€‚
- è² å‚µçµæ§‹å„ªåŒ–ï¼šé‚„æ¬¾é‡é»åœ¨é™ä½æ¯æœˆå‰›æ€§æ”¯å‡ºã€‚
- ä¿¡è²¸ (95.6è¬)ï¼šé¢¨éšªæœ€é«˜ï¼Œé›–é¤˜é¡ä¸‹é™ï¼Œä½†ä½”æ“šé¡¯è‘—ç¾é‡‘æµï¼Œå»ºè­°å„ªå…ˆè™•ç†ã€‚
- æˆ¿è²¸ (460.4è¬)ï¼šè‰¯æ€§è² å‚µï¼Œç¶­æŒæ­£å¸¸æœˆä¾›å³å¯ã€‚

2. é‡é»é¢¨éšªæç¤º (Red Flags)
âš ï¸ A. ã€Œå‡æ€§ã€æµå‹•æ€§é¢¨éšª
- ç›²é»ï¼šçœŸæ­£å±æ©Ÿæ™‚ï¼ŒéŠ€è¡Œå¯èƒ½ç¸®æ¸›ä¿¡è²¸æˆ–èª¿é™è³ªæŠ¼æˆæ•¸ã€‚
- å»ºè­°ï¼šæ‚¨çš„ã€Œæ‰‹é ­ç¾é‡‘ã€(40è¬) åƒ…å¤  5 å€‹æœˆã€‚ç›®æ¨™æ‹‰é«˜è‡³ 6~12 å€‹æœˆç”Ÿæ´»è²» (50-80è¬)ï¼Œå‹¿éåº¦ä¾è³´å€Ÿä¾†çš„éŒ¢ç•¶å‚™ç”¨é‡‘ã€‚

âš ï¸ B. å‡æ¯å¾ªç’°çš„æ»¯å¾Œæ‰“æ“Š
- é›™æ®ºæ•ˆæ‡‰ï¼šè‹¥åˆ©ç‡ç¶­æŒé«˜æª”ï¼Œæˆ¿è²¸/ä¿¡è²¸èˆ‡æŠ•è³‡åˆ©æ¯å°‡åŒæ™‚ä¸Šå‡ï¼Œä¾µè•æ·¨ç¾é‡‘æµã€‚
- å»ºè­°ï¼šå‹™å¿…æ¸¬è©¦ +0.5% ~ +1.0% å‡æ¯æƒ…å¢ƒã€‚è‹¥æ¸¬è©¦çµæœå°è‡´ç¾é‡‘æµè½‰è² ï¼Œå¿…é ˆå„ªå…ˆå„Ÿé‚„ä¿¡è²¸ã€‚

âš ï¸ C. è³‡ç”¢ç›¸é—œæ€§éé«˜
- é¢¨éšªï¼šè‹¥ç™¼ç”Ÿã€Œè‚¡å‚µé›™æ®ºã€ï¼ŒETF èˆ‡ä¿å–®å¯èƒ½åŒæ™‚éœ€è£œéŒ¢ (å¤šé ­ç‡’)ã€‚
- å»ºè­°ï¼šæª¢æŸ¥ä¿å–®åº•å±¤è³‡ç”¢æ˜¯å¦èˆ‡ç§‘æŠ€è‚¡é«˜åº¦é€£å‹•ã€‚

3. å…·é«”æ“ä½œå»ºè­° (Action Plan)
â˜… ç¬¬ä¸€éšæ®µï¼šä¿¡è²¸æ®²æ»…æˆ° (å„ªå…ˆé †åºï¼šé«˜)
- ç›®æ¨™ï¼š95.6 è¬ä¿¡è²¸ç›¡å¿«æ­¸é›¶ã€‚
- ç­–ç•¥ï¼šæ¯æœˆæ·¨ç¾é‡‘æµå…¨æ•¸æŠ•å…¥å„Ÿé‚„ä¿¡è²¸ï¼Œä¸é€²è¡Œå†æŠ•è³‡ã€‚
- æ•ˆç›Šï¼šé‚„æ¸…å¾Œæ¯æœˆè‡ªç”±ç¾é‡‘æµå¢åŠ  1~2 è¬ï¼ŒæŠ—é¢¨éšªèƒ½åŠ›å¤§å¹…æå‡ã€‚

â˜… ç¬¬äºŒéšæ®µï¼šå»ºç«‹ã€Œé˜²ç¦¦æ€§ã€ç¾é‡‘æ± 
- ç›®æ¨™ï¼šå°‡ç¾é‡‘éƒ¨ä½æå‡è‡³ 80 è¬ã€‚
- æ“ä½œï¼šæš«åœé…æ¯å†æŠ•å…¥ï¼Œå›¤ç©ç¾é‡‘ç›´åˆ°è¦†è“‹ä¸€å¹´ç¸½æ”¯å‡ºã€‚

â˜… ç¬¬ä¸‰éšæ®µï¼šç›£æ§æŒ‡æ¨™
- å‚µå‹™æ”¯å‡ºæ¯”ï¼šè‹¥ > 60% (æ›¿éŠ€è¡Œæ‰“å·¥)ï¼Œå®¹éŒ¯ç‡æ¥µä½ã€‚
- æ·¨å€¼ç¶­æŒç‡ç·©è¡ï¼šä»»ä¸€è³‡ç”¢ç·©è¡è·Œç ´ 15% æ™‚ï¼Œå‹™å¿…é–‹å§‹åŸ·è¡Œå»æ§“æ¡¿ (è³£è³‡ç”¢é‚„å‚µ)ã€‚
</textarea>
        <div style="text-align:right; margin-top:5px; font-size:0.8rem; color:var(--text-sub);">* é»æ“Šã€Œæœ¬åœ°å­˜æª”ã€ä»¥ä¿å­˜ç­†è¨˜ (å¯è‡ªç”±ç·¨è¼¯)</div>
      </div>
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="side-panel">
      <div class="section-card">
        <h3 style="margin:0 0 10px 0; color:var(--c-blue); font-size:1.1rem;">ğŸ’° æœˆæ”¶å…¥</h3>
        <div class="summary-row"><span>ä¸»å‹•è–ªè³‡</span><input id="inc_active" type="number" value="4.2" oninput="calc()"></div>
        <div class="summary-row"><span style="color:var(--c-gold); font-weight:bold;">è¢«å‹•é…æ¯</span><input id="inc_passive" type="number" value="5.5" oninput="calc()"></div>
        <div class="summary-row total-line" style="color:var(--c-blue)"><span>ç¸½æ”¶å…¥</span><span id="disp_inc_total" class="privacy-blur">0</span></div>
      </div>

      <div class="section-card">
        <h3 style="margin:0 0 10px 0; color:var(--c-danger); font-size:1.1rem;">ğŸ’¸ æœˆæ”¯å‡º (å«å‡æ¯)</h3>
        <div class="summary-row"><span>æˆ¿è²¸æœˆä¾›</span><input id="exp_house" type="number" value="3.1" oninput="calc()"></div>
        <div class="summary-row"><span>ä¿¡è²¸æœˆä¾›</span><input id="exp_personal" type="number" value="1.3" oninput="calc()"></div>
        <div class="summary-row"><span>ä¿éšª/ç”Ÿæ´»</span><input id="exp_life" type="number" value="2.0" oninput="calc()"></div>
        <div class="summary-row"><span>å½ˆæ€§æ”¯å‡º</span><input id="exp_flex" type="number" value="0.0" oninput="calc()"></div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
        <div class="summary-row" style="color:var(--text-sub)"><span>ä¿å–®åˆ©æ¯(è‡ªå‹•)</span><span id="disp_policy_interest" class="privacy-blur">0</span></div>
        <div class="summary-row" style="color:var(--text-sub)"><span>ETFåˆ©æ¯(è‡ªå‹•)</span><span id="disp_etf_interest" class="privacy-blur">0</span></div>
        <div class="summary-row" style="color:var(--text-sub); font-size:0.8rem;"><span>ğŸ”º å‡æ¯å¢åŠ åˆ©æ¯</span><span id="disp_rate_hike_impact" class="privacy-blur" style="color:var(--c-danger)">0</span></div>
        <div class="summary-row total-line" style="color:var(--c-danger)"><span>ç¸½æ”¯å‡º</span><span id="disp_exp_total" class="privacy-blur">0</span></div>
      </div>

      <div class="section-card" style="text-align:center;">
         <div style="font-size:0.9rem; color:var(--text-sub)">æœˆç¾é‡‘æµ</div>
         <div style="font-size:2rem; font-weight:800;" id="disp_surplus_big" class="privacy-blur">0</div>
         <div style="margin-top:5px; font-size:0.8rem;" id="surplus_msg"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let chartAsset = null;
  let chartFlow = null;

  // State
  let globalSimType = 'manual'; // 'manual' or 'history'
  let currentStockDrop = 0;
  let currentBalancedDrop = 0;

  const v = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const t = (id, txt) => { const el = document.getElementById(id); if(el) el.innerHTML = txt; };

  function calcDuration(dateStr, elId) {
    if(!dateStr) { t(elId, "æœªè¨­å®š"); return; }
    const start = new Date(dateStr);
    const now = new Date();
    if (start > now) { t(elId, "å¾…ç”Ÿæ•ˆ"); return; }
    let months = (now.getFullYear() - start.getFullYear()) * 12;
    months -= start.getMonth();
    months += now.getMonth();
    const years = Math.floor(months / 12);
    const remMonths = months % 12;
    let txt = "";
    if (years > 0) txt += `${years}å¹´`;
    txt += `${remMonths}å€‹æœˆ`;
    if (years===0 && remMonths===0) txt = "æœªæ»¿1å€‹æœˆ";
    t(elId, `æŒæœ‰: ${txt}`);
  }

  // æ­·å²åŠ‡æœ¬
  function setHistoryCrash(stockDrop, balancedDrop, label, desc) {
    globalSimType = 'history';
    currentStockDrop = stockDrop;
    currentBalancedDrop = balancedDrop;
    
    // Update UI
    document.getElementById('sim_slider').value = stockDrop;
    document.getElementById('sim_label').innerText = `-${stockDrop}%`;
    
    const detailBox = document.getElementById('crash_detail');
    detailBox.style.display = 'block';
    document.getElementById('crash_title').innerText = label;
    document.getElementById('crash_desc').innerText = `${desc} (ETFè·Œ ${stockDrop}%, ä¿å–®è·Œ ${balancedDrop}%)`;
    
    calc();
  }

  function manualSlider() {
      globalSimType = 'manual';
      const val = document.getElementById('sim_slider').value;
      document.getElementById('sim_label').innerText = `-${val}%`;
      document.getElementById('crash_detail').style.display = 'none';
      calc();
  }

  function resetSim() {
      document.getElementById('sim_slider').value = 0;
      manualSlider();
  }

  function renderAssetStatus(id, asset, loan, cost, mcLimit, liqLimit, isEtf, isSavings=false, rateHike=0) {
    const divAcc = v(`div_${id}`);
    // Dual ROI
    let priceRoi = cost > 0 ? ((asset - cost) / cost * 100) : 0;
    let totalRoi = cost > 0 ? ((asset + divAcc - cost) / cost * 100) : 0;

    const getColor = (val) => val >= 0 ? 'c-up' : 'c-down';
    const getSym = (val) => val >= 0 ? '+' : '';

    const roiHtml = `
        <div class="roi-wrapper">
            <div class="roi-row">
                <span class="roi-label">å«æ¯</span>
                <span class="roi-val ${getColor(totalRoi)}">${getSym(totalRoi)}${totalRoi.toFixed(1)}%</span>
            </div>
            <div class="roi-row">
                <span class="roi-label">ä¸å«æ¯</span>
                <span class="roi-val ${getColor(priceRoi)}">${getSym(priceRoi)} ${priceRoi.toFixed(1)}%</span>
            </div>
        </div>
    `;
    t(`roi_${id}`, roiHtml);

    const dateVal = document.getElementById(`date_${id}`).value;
    calcDuration(dateVal, `dur_${id}`);

    // Interest Calc
    const rate = v(`rate_${id}`);
    let effectiveRate = rate + rateHike;
    let interest = 0;
    if(loan > 0) interest = (loan * (effectiveRate/100)) / 12;

    // ---- RISK STATUS (CURRENT) ----
    let ratioText = "";
    let color = "b-safe";
    let triggerMC = 0, triggerLiq = 0;
    let bufferMC = 0, bufferLiq = 0;
    let barWidth = 0;

    if(isSavings) {
        ratioText = asset > 0 ? (loan/asset*100).toFixed(1) + "%" : "0%";
        t(`status_${id}`, `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;"><span style="font-size:0.75rem; color:var(--text-sub)">å€Ÿæ¬¾æ¯” <span class="badge b-safe" style="font-size:0.7rem; padding:2px 6px;">${ratioText}</span></span></div><div style="font-size:0.85rem; color:var(--c-safe); font-weight:bold; margin-top:8px;">ğŸŸ¢ å„²è“„å‹ (ç„¡è‚¡å¸‚é¢¨éšª)</div>`);
        // Sim Result for Savings
        t(`sim_res_${id}`, `<div style="font-weight:bold; font-size:0.9rem;" class="privacy-blur">${asset.toFixed(0)} <small style="color:var(--text-sub)">è¬</small></div><div style="font-size:0.8rem; color:var(--text-sub); margin-top:4px;">ğŸ›¡ï¸ åƒ¹å€¼æ†å®š</div>`);
        return { interest, bufferMC: 100, bufferLiq: 100, name: id, divAcc, loan, asset };
    }

    // Regular or ETF
    let posMC, posLiq;

    if(!isEtf) {
        // Policy
        const r = asset>0 ? loan/asset*100 : 0;
        ratioText = r.toFixed(1) + "%";
        if(r >= liqLimit) color = "b-danger"; else if(r >= mcLimit) color = "b-warn";
        
        triggerMC = loan / (mcLimit/100);
        triggerLiq = loan / (liqLimit/100);
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
        barWidth = Math.min(r, 100);
        posMC = mcLimit;
        posLiq = liqLimit;
    } else {
        // ETF
        const maint = loan>0 ? (asset/loan*100) : 0;
        const ltv = asset>0 ? (loan/asset*100) : 0;
        ratioText = `å€Ÿ${ltv.toFixed(0)}% | ç¶­${loan>0?maint.toFixed(0)+'%':'-'}`;
        
        if(loan>0 && maint < 130) color = "b-warn";
        if(loan>0 && maint < 115) color = "b-danger";

        triggerMC = loan * 1.3; // 130%
        triggerLiq = loan * 1.15; // 115%
        
        if(asset > 0) {
            bufferMC = Math.max(0, (1 - triggerMC/asset)*100);
            bufferLiq = Math.max(0, (1 - triggerLiq/asset)*100);
        }
        // For visual bar: approximate Maint to LTV
        barWidth = Math.min(ltv, 100);
        posMC = 77;
        posLiq = 87;
    }

    let barColor = "var(--c-safe)";
    if(barWidth >= posMC) barColor = "var(--c-warn)";
    if(barWidth >= posLiq) barColor = "var(--c-danger)";

    const statusHtml = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
            <span style="font-size:0.75rem; color:var(--text-sub)">${isEtf?'é¢¨éšªæŒ‡æ¨™':'å€Ÿæ¬¾æ¯”'} <span class="badge ${color}" style="font-size:0.7rem; padding:2px 6px;">${ratioText}</span></span>
        </div>
        <div class="water-track" title="æ°´ä½åœ–">
            <div class="water-fill" style="width:${barWidth}%; background:${barColor}"></div>
            <div class="water-mark mark-mc" style="left:${posMC}%" title="è£œç¹³ç·š"></div>
            <div class="water-mark mark-liq" style="left:${posLiq}%" title="æ–·é ­ç·š"></div>
        </div>
        <div class="risk-lines">
            <div class="risk-row">
                <span class="line-label"><i class="fas fa-exclamation-circle" style="color:var(--c-warn)"></i> è£œç¹³ <span class="line-trigger privacy-blur" style="color:var(--c-warn)">${triggerMC.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-warn); font-size:0.85rem;">å‰© ${bufferMC.toFixed(0)}%</span>
            </div>
            <div class="risk-row">
                <span class="line-label"><i class="fas fa-skull" style="color:var(--c-danger)"></i> æ–·é ­ <span class="line-trigger privacy-blur" style="color:var(--c-danger)">${triggerLiq.toFixed(1)}</span></span>
                <span class="line-val" style="color:var(--c-danger); font-size:0.85rem;">å‰© ${bufferLiq.toFixed(0)}%</span>
            </div>
        </div>
    `;
    t(`status_${id}`, statusHtml);

    // ---- SIMULATION ----
    let drop = 0;
    if (globalSimType === 'history') {
        drop = isEtf ? currentStockDrop : currentBalancedDrop;
    } else {
        drop = parseFloat(document.getElementById('sim_slider').value);
    }
    
    // UI update for drop label
    document.getElementById('sim_label').innerText = `-${drop}%`;

    const factor = 1 - (drop / 100);
    const simAsset = asset * factor;
    
    let simTxt = "å®‰å…¨";
    let simCls = "b-safe";
    let topUpNeeded = 0;

    if(!isEtf) {
        const simRatio = simAsset>0 ? loan/simAsset*100 : 0;
        if(simRatio >= liqLimit) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
        else if(simRatio >= mcLimit) { simTxt = "è£œç¹³"; simCls = "b-warn"; }
        
        if(simRatio > mcLimit) {
            const maxLoan = simAsset * (mcLimit/100);
            topUpNeeded = loan - maxLoan;
        }
    } else {
        const simMaint = loan>0 ? simAsset/loan*100 : 0;
        if(loan>0) {
            if(simMaint < 115) { simTxt = "æ–·é ­"; simCls = "b-danger"; }
            else if(simMaint < 130) { simTxt = "è¿½ç¹³"; simCls = "b-warn"; }
            
            if(simMaint < 130) {
                const targetLoan = simAsset / 1.3;
                topUpNeeded = loan - targetLoan;
            }
        }
    }

    // Sim display
    let simRatioDisp = "";
    if(isEtf) simRatioDisp = loan>0 ? (simAsset/loan*100).toFixed(0)+"%" : "-";
    else simRatioDisp = (simAsset>0 ? loan/simAsset*100 : 0).toFixed(1)+"%";

    let topUpHtml = "";
    if(topUpNeeded > 0) topUpHtml = `<div style="font-size:0.8rem; color:var(--c-danger); margin-top:2px; font-weight:bold;">ğŸ’¸ éœ€è£œ ${topUpNeeded.toFixed(1)} è¬</div>`;

    const simHtml = `
        <div style="font-weight:bold; font-size:0.9rem;" class="privacy-blur">${simAsset.toFixed(0)} <small style="color:var(--text-sub)">è¬</small></div>
        <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.8rem;">
            <span>${simRatioDisp}</span>
            <span class="badge ${simCls}">${simTxt}</span>
        </div>
        ${topUpHtml}
    `;
    t(`sim_res_${id}`, simHtml);

    return { interest, bufferMC, bufferLiq, name: id, divAcc, loan, asset };
  }

  function calc() {
    const rateHike = parseFloat(document.getElementById('rate_slider').value);
    document.getElementById('rate_label').innerText = rateHike.toFixed(3) + "%";

    let policyTotalInterest = 0;
    let etfTotalInterest = 0;
    let minBuffer = 100;
    let minBufferName = "ç„¡";
    let totalDividends = 0;
    
    const processRisk = (res) => {
        if (res.bufferMC < minBuffer && res.bufferMC >= 0 && res.name !== 'e') { 
            minBuffer = res.bufferMC;
            minBufferName = res.name;
        }
        totalDividends += res.divAcc;
        return res.interest;
    };

    const rA = renderAssetStatus('a', v('asset_a'), v('loan_a'), v('cost_a'), 80, 90, false, false, rateHike);
    const rB = renderAssetStatus('b', v('asset_b'), v('loan_b'), v('cost_b'), 80, 90, false, false, rateHike);
    const rC = renderAssetStatus('c', v('asset_c'), v('loan_c'), v('cost_c'), 80, 90, false, false, rateHike);
    const rD = renderAssetStatus('d', v('asset_d'), v('loan_d'), v('cost_d'), 60, 70, false, false, rateHike);
    const rE = renderAssetStatus('e', v('asset_e'), v('loan_e'), v('cost_e'), 80, 90, false, true, rateHike);
    const rETF = renderAssetStatus('etf', v('asset_etf'), v('loan_etf'), v('cost_etf'), 0, 0, true, false, rateHike);

    policyTotalInterest = processRisk(rA) + processRisk(rB) + processRisk(rC) + processRisk(rD) + processRisk(rE);
    etfTotalInterest = processRisk(rETF);

    t('disp_policy_interest', policyTotalInterest.toFixed(2));
    t('disp_etf_interest', etfTotalInterest.toFixed(2));
    const totalInvestInterest = policyTotalInterest + etfTotalInterest;

    const investAsset = v('asset_a')+v('asset_b')+v('asset_c')+v('asset_d')+v('asset_e')+v('asset_etf');
    const investDebt = v('loan_a')+v('loan_b')+v('loan_c')+v('loan_d')+v('loan_e')+v('loan_etf');
    const investCost = v('cost_a')+v('cost_b')+v('cost_c')+v('cost_d')+v('cost_e')+v('cost_etf');
    const houseVal = v('asset_house');
    const houseDebt = v('debt_house');
    const personalDebt = v('debt_personal');
    const cash = v('asset_cash');

    const totalAssets = investAsset + houseVal + cash;
    const totalLiabilities = investDebt + houseDebt + personalDebt;
    const netWorth = totalAssets - totalLiabilities;

    t('val_net_worth', netWorth.toLocaleString());
    t('val_assets', totalAssets.toLocaleString());
    t('val_liabilities', totalLiabilities.toLocaleString());
    t('val_invest_assets', investAsset.toLocaleString());
    t('val_cost', investCost.toLocaleString());
    t('val_total_div', totalDividends.toLocaleString()); 
    
    // FIRE Calculation
    const fireTarget = v('fire_target');
    const firePct = fireTarget > 0 ? (netWorth / fireTarget) * 100 : 0;
    const fireDiff = fireTarget - netWorth;
    t('fire_pct', firePct.toFixed(1) + "%");
    t('fire_diff', fireDiff > 0 ? fireDiff.toLocaleString() : "0");
    document.getElementById('fire_bar').style.width = Math.min(firePct, 100) + "%";
    
    const pl = (investAsset + totalDividends) - investCost;
    const elPl = document.getElementById('val_pl');
    elPl.innerText = (pl>0?"+":"") + pl.toLocaleString();
    elPl.style.color = pl>=0 ? "var(--c-safe)" : "var(--c-danger)";

    const debtRatio = totalAssets>0 ? (totalLiabilities/totalAssets*100) : 0;

    const incAct = v('inc_active');
    const incPas = v('inc_passive');
    const inc = incAct + incPas;
    t('disp_inc_total', inc.toFixed(2));
    t('val_income', inc.toFixed(1));

    const expFix = v('exp_house') + v('exp_personal') + v('exp_life') + v('exp_flex');
    const hikeImpact = ((houseDebt + personalDebt) * (rateHike/100)) / 12;
    t('disp_rate_hike_impact', hikeImpact.toFixed(2));

    const totalExp = expFix + totalInvestInterest + hikeImpact;
    t('disp_exp_total', totalExp.toFixed(2));
    t('val_expense', totalExp.toFixed(1));

    const surplus = inc - totalExp;
    t('val_surplus', surplus.toFixed(2));
    
    const surBig = document.getElementById('disp_surplus_big');
    surBig.innerText = (surplus>0?"+":"") + surplus.toFixed(2) + " è¬";
    surBig.style.color = surplus>=0 ? "var(--c-safe)" : "var(--c-danger)";
    t('surplus_msg', surplus>=0 ? "è²¡å‹™å¥åº·" : "ç¾é‡‘æµèµ¤å­—");

    const unusedCredit = v('unused_credit');
    const unusedPledge = v('unused_pledge');
    const totalLiquidity = cash + unusedCredit + unusedPledge;
    t('total_liquidity_display', `ç¸½å¯å‹•ç”¨å‚™ç”¨é‡‘: ${totalLiquidity} è¬`);

    updateCharts([investAsset, houseVal, cash], [incAct, incPas, totalExp]);
  }

  function initCharts() {
    if (chartAsset) chartAsset.destroy();
    if (chartFlow) chartFlow.destroy();

    const ctxAsset = document.getElementById('assetChart').getContext('2d');
    chartAsset = new Chart(ctxAsset, {
        type: 'doughnut',
        data: {
            labels: ['æŠ•è³‡', 'æˆ¿ç”¢', 'ç¾é‡‘'],
            datasets: [{ data: [1, 1, 1], backgroundColor: ['#8b5cf6', '#f97316', '#10b981'], borderWidth: 0 }]
        },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%' }
    });

    const ctxFlow = document.getElementById('flowChart').getContext('2d');
    chartFlow = new Chart(ctxFlow, {
        type: 'bar',
        data: {
            labels: ['æ”¶æ”¯'],
            datasets: [
                { label: 'ä¸»å‹•', data: [0], backgroundColor: '#3b82f6', stack: 'Income' },
                { label: 'è¢«å‹•', data: [0], backgroundColor: '#eab308', stack: 'Income' },
                { label: 'æ”¯å‡º', data: [0], backgroundColor: '#ef4444', stack: 'Expense' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { beginAtZero: true } } }
    });
  }

  function updateCharts(assets, flows) {
    if(chartAsset) { chartAsset.data.datasets[0].data = assets; chartAsset.update(); }
    if(chartFlow) { chartFlow.data.datasets[0].data = [flows[0]]; chartFlow.data.datasets[1].data = [flows[1]]; chartFlow.data.datasets[2].data = [flows[2]]; chartFlow.update(); }
  }

  function exportPDF() {
    const el = document.getElementById('dashboard-container');
    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'è²¡å‹™è‡ªç”±å ±å‘Š_Strategy.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS:true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    alert("æ­£åœ¨ç”¢ç”Ÿ PDF (å«ç­–ç•¥ç­†è¨˜)ï¼Œè«‹ç¨å€™...");
    html2pdf().set(opt).from(el).save();
  }

  function saveData() {
    const d = {};
    // Select all inputs AND textareas (notes)
    document.querySelectorAll('input, textarea').forEach(e => d[e.id] = e.value);
    localStorage.setItem('wcj_final_v36_notes', JSON.stringify(d));
    alert('å·²å„²å­˜ (å«ç­†è¨˜)');
  }
  
  function exportJSON() {
    const d = {};
    document.querySelectorAll('input, textarea').forEach(e => d[e.id] = e.value);
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d));
    const node = document.createElement('a');
    node.setAttribute("href", dataStr);
    node.setAttribute("download", "financial_backup_" + new Date().toISOString().slice(0,10) + ".json");
    document.body.appendChild(node);
    node.click();
    node.remove();
  }
  
  function importJSON(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const json = JSON.parse(e.target.result);
            for(k in json) { if(document.getElementById(k)) document.getElementById(k).value = json[k]; }
            calc();
            alert("âœ… æ•¸æ“šé‚„åŸæˆåŠŸï¼");
        } catch(e) { alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
    };
    reader.readAsText(file);
    input.value = '';
  }
  
  function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'); }
  
  function togglePrivacy() {
    document.body.classList.toggle('privacy-mode');
    const btn = document.getElementById('btnPrivacy');
    if(document.body.classList.contains('privacy-mode')) {
        btn.innerHTML = '<i class="fas fa-eye-slash"></i> é¡¯ç¤ºé‡‘é¡';
        btn.classList.add('active');
    } else {
        btn.innerHTML = '<i class="fas fa-eye"></i> éš±è—é‡‘é¡';
        btn.classList.remove('active');
    }
  }

  window.onload = () => {
    initCharts();
    const d = JSON.parse(localStorage.getItem('wcj_final_v36_notes'));
    if(d) {
        for(k in d) { if(document.getElementById(k)) document.getElementById(k).value=d[k]; }
    }
    calc();
  };
</script>
</body>
</html>
